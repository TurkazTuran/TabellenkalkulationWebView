<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta
            name="viewport"
            content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
    />
    <!-- Content Security Policy to mitigate XSS when loading this page in a WebView -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src https://api.aladhan.com;">
    <title>NAMAZ VAXTI</title>
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        :root {
          --bg-0: #0b0f14;
          --bg-1: #0a0d12;
          --bg-2: #0c1118;
          --panel: rgba(10, 14, 20, 0.92);
          --panel-soft: rgba(13, 19, 28, 0.7);
          --card: rgba(14, 21, 31, 0.85);
          --text: #e5e7eb;
          --muted: #94a3b8;
          --accent: #60a5fa;
          --accent-strong: #3b82f6;
          --accent-soft: rgba(37, 99, 235, 0.18);
          --danger: #ef4444;
          --border: rgba(255, 255, 255, 0.05);
          --border-strong: rgba(59, 130, 246, 0.6);

          /* Active & Upcoming color system */
          --active-green-base: #22c55e;
          --active-green-bright: #41ff9d;
          --active-green-glow: #16ff78;

          --upcoming-cyan-base: #06b6d4;
          --upcoming-cyan-bright: #fefefe;

          color-scheme: dark;
        }

        html {
          width:100%;
          overflow-x:hidden;
        }
        body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
            sans-serif;
          background: linear-gradient(
            135deg,
            var(--bg-0) 0%,
            var(--bg-1) 40%,
            var(--bg-2) 100%
          );
          color: var(--text);
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          /* Safe-area nur vertikal anwenden damit kein horizontales √úberlaufen entsteht */
          padding: env(safe-area-inset-top,10px) 10px env(safe-area-inset-bottom,10px) 10px;
          -webkit-tap-highlight-color: transparent;
          overflow-x: hidden;
        }

        .prayer-app {
          width: 100%;
          max-width: 420px;
          background: transparent;
          border-radius: 20px;
          padding: 20px;
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        .header {
          text-align: center;
        }

        .app-title {
          font-size: clamp(24px, 5vw, 28px);
          font-weight: 600;
          color: var(--accent);
          margin-bottom: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          letter-spacing: 0.2px;
          flex-wrap: wrap;
        }

        .location {
          font-size: clamp(13px, 3.5vw, 14px);
          color: var(--muted);
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 5px;
          flex-wrap: wrap;
        }

        .status-indicator {
          display: inline-block;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          animation: pulse 2s infinite;
          flex-shrink: 0;
        }
        .status-indicator.loading {
          background-color: #fbbf24;
        }
        .status-indicator.success {
          background-color: #10b981;
        }
        .status-indicator.error {
          background-color: var(--danger);
        }

        @keyframes pulse {
          0%,
          100% {
            opacity: 1;
          }
          50% {
            opacity: 0.5;
          }
        }

        .date-section {
          text-align: center;
          padding: 12px;
          background: var(--panel-soft);
          border-radius: 15px;
          border: 1px solid var(--border);
        }

        /* Controls Toggle */
        .controls-toggle {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px;
          background: var(--panel-soft);
          border: 1px solid var(--border);
          border-radius: 14px;
          cursor: pointer;
          user-select: none;
          transition: all 0.3s ease;
        }

        .controls-toggle:active {
          transform: scale(0.98);
        }

        .controls-toggle-label {
          font-size: 14px;
          font-weight: 600;
          color: var(--accent);
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .controls-toggle-arrow {
          display: inline-block;
          width: 20px;
          height: 20px;
          transition: transform 0.3s ease;
          color: var(--accent);
        }

        .controls-toggle.collapsed .controls-toggle-arrow {
          transform: rotate(-90deg);
        }

        /* Controls */
        .controls {
          display: grid;
          gap: 10px;
          background: var(--panel-soft);
          border: 1px solid var(--border);
          border-radius: 14px;
          padding: 12px;
          overflow: visible;
          max-height: 500px;
          opacity: 1;
          transition: all 0.3s ease;
        }

        .controls.collapsed {
          max-height: 0;
          opacity: 0;
          padding: 0 12px;
          overflow: hidden;
        }

        .controls-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 8px;
        }
        .controls .field {
          display: flex;
          flex-direction: column;
          gap: 6px;
          min-width: 0;
        }
        .controls label {
          font-size: 12px;
          color: var(--muted);
        }
        .controls input,
        .controls select {
          background: rgba(255,255,255,0.03);
          color: var(--text);
          border: 1px solid var(--border);
          border-radius: 10px;
          padding: 10px 12px;
          font-size: 14px;
          min-height: 44px;
          outline: none;
          width: 100%;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        .controls input:focus,
        .controls select:focus {
          border-color: var(--border-strong);
          box-shadow: 0 0 0 3px var(--accent-soft);
        }
        .controls-actions {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 8px;
        }
        .btn {
          background: var(--accent);
          color: var(--bg-0);
          border: none;
          padding: 10px 12px;
          border-radius: 10px;
          cursor: pointer;
          font-weight: 600;
          font-size: 14px;
        }
        .btn.secondary {
          background: rgba(96,165,250,0.12);
          color: var(--text);
          border: 1px solid var(--border);
        }
        .btn:active { transform: scale(0.98); }

        .gregorian-date {
          font-size: clamp(16px, 4.5vw, 18px);
          font-weight: 600;
          color: var(--accent);
          margin-bottom: 5px;
          line-height: 1.3;
        }

        .hijri-date {
          font-size: clamp(12px, 3.5vw, 14px);
          color: var(--muted);
          line-height: 1.3;
        }

        .current-time-section {
          text-align: center;
          padding: 16px 12px;
          background: var(--panel-soft);
          border-radius: 15px;
          border: 1px solid var(--border);
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .current-time {
          font-size: clamp(32px, 10vw, 40px);
          font-weight: bold;
          color: var(--accent);
          text-shadow: 0 0 10px rgba(96, 165, 250, 0.15);
          font-variant-numeric: tabular-nums;
          line-height: 1;
        }

        .next-prayer-info {
          font-size: clamp(18px, 4vw, 20px);
          color: var(--muted);
          line-height: 1.2;
          font-weight: 500;
        }

        .countdown-timer {
          font-size: clamp(22px, 6vw, 32px);
          font-weight: 700;
          color: var(--danger);
          font-variant-numeric: tabular-nums;
          letter-spacing: 1px;
        }

        .prayer-times-grid {
          display: grid;
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .prayer-card {
          position: relative;
          isolation: isolate;
          background: var(--card);
          border-radius: 12px;
          padding: 16px 12px;
          text-align: center;
          transition: all 0.25s ease;
          border: 1px solid var(--border);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          min-height: 80px;
          overflow: hidden;
        }

        .prayer-card:active {
          transform: scale(0.98);
        }

        .prayer-name {
          font-size: clamp(16px, 3.5vw, 18px);
          font-weight: 600;
          color: var(--muted);
          margin-bottom: 6px;
          letter-spacing: 0.5px;
          text-shadow: 0 0 8px rgba(96, 165, 250, 0.5);
        }

        .prayer-time {
          font-size: clamp(20px, 5vw, 24px);
          font-weight: 700;
          color: var(--text);
          font-variant-numeric: tabular-nums;
          letter-spacing: 0.5px;
        }

        /* CURRENT (active) prayer */
        .prayer-card.active {
          background: radial-gradient(
            circle at 50% 40%,
            rgba(34, 197, 94, 0.3),
            rgba(14, 21, 31, 0.92) 70%
          );
          border: 1px solid var(--active-green-base);
          box-shadow: 0 0 1px 1px rgba(34, 197, 94, 0.75),
            0 0 9px 3px rgba(134, 245, 175, 0.55),
            0 0 2px 5px rgba(34, 197, 94, 0.35),
            inset 0 0 8px rgba(34, 197, 94, 0.28);
          transform: translateY(-2px) scale(1);
          transition: all 0.45s cubic-bezier(0.25, 0.6, 0.3, 1);
          backdrop-filter: blur(2px) saturate(135%);
          -webkit-backdrop-filter: blur(4px) saturate(135%);
        }
        .prayer-card.active::before {
          content: "";
          position: absolute;
          inset: -10px;
          border-radius: 16px;
          background: radial-gradient(
              circle at 50% 55%,
              rgba(34, 197, 94, 0.55),
              transparent 60%
            ),
            radial-gradient(
              circle at 30% 30%,
              rgba(34, 197, 94, 0.35),
              transparent 70%
            );
          opacity: 0.55;
          filter: blur(15px);
          animation: activeAura 5s ease-in-out infinite;
          z-index: -1;
          pointer-events: none;
        }
        @keyframes activeAura {
          0%,
          100% {
            opacity: 0.45;
            transform: scale(1);
          }
          50% {
            opacity: 0.85;
            transform: scale(1.06);
          }
        }
        .prayer-card.active .prayer-name {
          color: #ffffff;
          font-size: clamp(16px, 6.5vw, 20px);
          font-weight: 900;
          background: rgba(0, 0, 0, 0.75);
          padding: 6px 14px;
          border-radius: 999px;
          border: 1px solid rgba(65, 255, 157, 0.35);
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }
        .prayer-card.active .prayer-time {
          color: #ffffff;
          font-size: clamp(20px, 8vw, 30px);
          font-weight: 800;
          background: rgba(0, 0, 0, 0.75);
          padding: 10px 18px;
          border-radius: 18px;
          border: 1px solid rgba(65, 255, 157, 0.35);
          margin-top: 10px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }

        /* UPCOMING prayer */
        .prayer-card.upcoming {
          background: linear-gradient(
            145deg,
            rgba(4, 82, 177, 0.412),
            rgba(14, 21, 31, 0.92)
          );
          border: 2px solid #d4a006b3;
          transform: translateY(-2px) scale(1.05);
          transition: all 0.45s cubic-bezier(0.25, 0.6, 0.3, 1);
        }
        .prayer-card.upcoming::before {
          content: "";
          position: absolute;
          inset: -8px;
          border-radius: 14px;
          opacity: 0.45;
          filter: blur(12px);
          animation: upcomingPulse 6s ease-in-out infinite;
          z-index: -1;
          pointer-events: none;
        }
        @keyframes upcomingPulse {
          0%,
          100% {
            opacity: 0.35;
            transform: scale(1);
          }
          50% {
            opacity: 0.7;
            transform: scale(1.04);
          }
        }
        .prayer-card.upcoming .prayer-name,
        .prayer-card.upcoming .prayer-time {
          color: var(--upcoming-cyan-bright);
          text-shadow: 0 0 8px #000000;
        }

        /* If both classes somehow appear, favor active look */
        .prayer-card.active.upcoming {
          outline: 0;
        }

        /* Dim others slightly */
        .prayer-card:not(.active):not(.upcoming) {
          opacity: 0.94;
          transition: opacity 0.3s ease;
        }
        .prayer-card:not(.active):not(.upcoming):hover {
          opacity: 1;
        }

        .loading {
          text-align: center;
          padding: 30px 20px;
          color: var(--muted);
          font-size: clamp(13px, 3.5vw, 14px);
          grid-column: 1 / -1;
        }

        .error {
          text-align: center;
          padding: 20px 16px;
          color: var(--danger);
          font-size: clamp(13px, 3.5vw, 14px);
          background: rgba(239, 68, 68, 0.1);
          border-radius: 12px;
          border: 1px solid rgba(239, 68, 68, 0.2);
          grid-column: 1 / -1;
          line-height: 1.5;
        }

        .refresh-button {
          background: var(--accent);
          color: var(--bg-0);
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          margin-top: 12px;
          font-size: clamp(13px, 3.5vw, 14px);
          font-weight: 600;
          transition: all 0.2s ease;
          touch-action: manipulation;
        }
        .refresh-button:active {
          transform: scale(0.96);
          background: var(--accent-strong);
        }

        /* Responsive tweaks */
        @media (max-width: 500px) {
          .controls-row,
          .controls-actions {
            grid-template-columns: 1fr;
          }
          .btn { width: 100%; }
        }
        @media (max-width: 360px) {
          .prayer-app {
            padding: 16px;
            gap: 12px;
          }
          .prayer-card {
            padding: 14px 10px;
            min-height: 75px;
          }
          .current-time-section {
            padding: 14px 10px;
          }
          .prayer-name {
            font-size: 15px;
          }
          .prayer-time {
            font-size: 19px;
          }
          .controls {
            padding: 10px;
            gap: 8px;
          }
          .controls input,
          .controls select {
            padding: 8px 10px;
            font-size: 13px;
          }
        }
        @media (max-width: 320px) {
          .prayer-app {
            padding: 12px;
            border-radius: 16px;
          }
          .prayer-card {
            padding: 12px 8px;
            min-height: 70px;
          }
        }
        @media (orientation: landscape) and (max-height: 500px) {
          body {
            padding: 8px;
          }
          .prayer-app {
            max-width: 100%;
            padding: 16px;
          }
          .current-time-section {
            padding: 12px;
          }
          .current-time {
            font-size: clamp(28px, 8vw, 32px);
          }
        }
        @media (min-width: 600px) {
          .prayer-app {
            padding: 30px 24px;
          }
          .prayer-times-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
          }
          .prayer-name {
            font-size: 18px;
          }
          .prayer-time {
            font-size: 24px;
          }
          .current-time {
            font-size: 42px;
          }
        }
        @media (min-width: 900px) {
          .prayer-app {
            max-width: 820px;
          }
          .prayer-times-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
          }
          .prayer-card {
            padding: 22px 16px;
            min-height: 120px;
          }
          .prayer-name {
            font-size: 20px;
          }
          .prayer-time {
            font-size: 30px;
          }
          .current-time {
            font-size: 48px;
          }
          .next-prayer-info {
            font-size: 22px;
          }
          .countdown-timer {
            font-size: 34px;
          }
        }
        @media (min-width: 1200px) {
          .prayer-app {
            max-width: 960px;
          }
          .prayer-times-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr));
          }
          .prayer-card {
            padding: 26px 18px;
            min-height: 140px;
          }
          .prayer-name {
            font-size: 22px;
          }
          .prayer-time {
            font-size: 34px;
          }
          .current-time {
            font-size: 54px;
          }
          .next-prayer-info {
            font-size: 24px;
          }
          .countdown-timer {
            font-size: 38px;
          }
        }

        /* Accessibility: reduce motion */
        @media (prefers-reduced-motion: reduce) {
          * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
          }
          .prayer-card.active,
          .prayer-card.upcoming {
            animation: none !important;
            transform: translateY(-3px) scale(1.04);
          }
          .prayer-card.active::before,
          .prayer-card.upcoming::before {
            animation: none !important;
          }
        }
    </style>
</head>
<body>
<div class="prayer-app">
    <div class="header">
        <div class="app-title">
            NAMAZ VAXTI
            <span class="status-indicator loading" id="statusIndicator"></span>
        </div>
        <div class="location" id="locationDisplay">üìç Berlin, Almanya</div>
    </div>

    <div style="display: flex; justify-content: center; align-items: center; margin: 16px 0; padding: 0 20px;">
        <img src="basmalah.png" alt="ÿ®Ÿêÿ≥ŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸÖŸéŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖ" style="max-width: min(85%, 300px); height: auto; display: block; filter: drop-shadow(0 2px 8px rgba(96, 165, 250, 0.15));" />
    </div>

    <div class="controls-toggle" id="controlsToggle">
        <span class="controls-toggle-label">
            ‚öôÔ∏è Einstellungen
        </span>
        <span class="controls-toggle-arrow">‚ñº</span>
    </div>

    <div class="controls" id="controls">
        <div class="controls-row">
      <div class="field">
        <label for="countrySelect">√úlke / Country</label>
        <select id="countrySelect">
          <option value="" data-iso="">-- Land ausw√§hlen --</option>
        </select>
            </div>
            <div class="field">
        <label for="citySelect">≈ûehir / City</label>
        <select id="citySelect" style="display:none;">
          <option value="">-- Stadt ausw√§hlen --</option>
        </select>
        <input id="cityInput" placeholder="z.B. Berlin, ƒ∞stanbul, Paris" />
        <small id="cityHint" style="color: var(--muted);">Tipp: Wenn deine Stadt nicht in der Liste ist, w√§hle "Andere Stadt‚Ä¶" und gib sie manuell ein.</small>
            </div>
        </div>
        <div class="controls-row">
            <div class="field">
                <label for="methodSelect">Hesaplama Metodu / Method</label>
                <select id="methodSelect">
                    <option value="13">Diyanet ƒ∞≈üleri (T√ºrkiye) [13]</option>
                    <option value="3">Muslim World League [3]</option>
                    <option value="2">ISNA - North America [2]</option>
                    <option value="5">Egyptian General Authority [5]</option>
                    <option value="4">Umm Al-Qura, Makkah [4]</option>
                    <option value="1">University of Islamic Sciences, Karachi [1]</option>
                    <option value="14">Spiritual Administration of Muslims of Russia [14]</option>
                    <option value="12">Union of Islamic Organisations of France [12]</option>
                    <option value="11">Majlis Ugama Islam Singapura [11]</option>
                    <option value="9">Kuwait [9]</option>
                    <option value="10">Qatar [10]</option>
                </select>
            </div>
            <div class="field">
                <label for="modeSelect">Modus</label>
                <select id="modeSelect">
                    <option value="city">Stadt & Land</option>
                    <option value="coords">GPS Koordinaten</option>
                </select>
            </div>
        </div>
        <div class="controls-actions">
            <button class="btn" id="applyBtn">√úbernehmen</button>
            <button class="btn secondary" id="gpsBtn">GPS verwenden</button>
        </div>
    </div>

    <div class="date-section">
        <div class="gregorian-date" id="gregorianDate">Y√ºkleniyor...</div>
        <div class="hijri-date" id="hijriDate">--</div>
    </div>

    <div class="current-time-section">
        <div class="current-time" id="currentTime">--:--:--</div>
        <div class="next-prayer-info" id="nextPrayerInfo">--</div>
        <div class="countdown-timer" id="countdownTimer">--:--:--</div>
    </div>

    <div class="prayer-times-grid" id="prayerTimesGrid">
        <div class="loading">Namaz vakitleri y√ºkleniyor...</div>
    </div>
</div>

<script>
    let prayerData = null;
    let countdownInterval = null;
    let currentCity = "Berlin";
    let currentCountry = "Germany";
    let calcMethod = 13; // default Diyanet
    let currentMode = "city"; // 'city' | 'coords'
    let currentCoords = null; // {lat, lon}
    let controlsCollapsed = true; // Default: collapsed

    // localStorage helpers
    const LS_KEYS = {
      mode: "prayerApp.mode",
      city: "prayerApp.city",
      country: "prayerApp.country",
      coords: "prayerApp.coords",
      method: "prayerApp.method",
      controlsCollapsed: "prayerApp.controlsCollapsed",
      countriesCache: "prayerApp.countriesCache.v1",
      citiesCache: "prayerApp.citiesCache.v1", // per country
    };

    // Countries cache config (24h)
    const COUNTRIES_CACHE_TTL_MS = 24 * 60 * 60 * 1000;

    async function fetchCountriesFromAPI() {
      const url = "https://api.aladhan.com/v1/countries";
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Countries HTTP ${res.status}`);
      const json = await res.json();
      if (json.code !== 200 || !json.data) throw new Error("Countries API returned error");
      const list = json.data
        .filter(Boolean)
        .map((c) => ({ name: String(c.name || '').trim(), iso2: String(c.iso2 || '').trim() }))
        .filter((c) => c.name.length > 0)
        .sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
      return list;
    }

    // City list handling (API does not provide a full endpoint, so we'll attempt heuristic fallback)
    // NOTE: AlAdhan API has no official cities list endpoint documented. We'll keep a small curated list for popular countries.
    const STATIC_CITIES = {
      Germany: ["Berlin","Hamburg","Munich","Cologne","Frankfurt","Stuttgart","Dresden","Leipzig","Hannover"],
      T√ºrkiye: ["ƒ∞stanbul","Ankara","ƒ∞zmir","Bursa","Konya","Adana","Gaziantep","Kayseri","Trabzon"],
      France: ["Paris","Lyon","Marseille","Toulouse","Bordeaux","Nice","Nantes","Lille"],
      "United Kingdom": ["London","Birmingham","Manchester","Leeds","Liverpool","Edinburgh","Glasgow"],
      "United States": ["New York","Los Angeles","Chicago","Houston","Philadelphia","Phoenix","San Antonio","Dallas"],
      Canada: ["Toronto","Montreal","Vancouver","Calgary","Ottawa","Edmonton","Winnipeg"],
      Russia: ["Moscow","Saint Petersburg","Kazan","Novosibirsk"],
      Malaysia: ["Kuala Lumpur","Johor Bahru","George Town","Ipoh"],
      Indonesia: ["Jakarta","Bandung","Surabaya","Medan","Yogyakarta"],
      Pakistan: ["Karachi","Lahore","Islamabad","Rawalpindi","Peshawar"],
      India: ["Mumbai","Delhi","Hyderabad","Bangalore","Chennai","Kolkata"],
      Egypt: ["Cairo","Alexandria","Giza","Luxor"],
      Morocco: ["Rabat","Casablanca","Marrakesh","Fes"],
      Algeria: ["Algiers","Oran","Constantine"],
      Tunisia: ["Tunis","Sfax","Sousse"],
      Austria: ["Wien","Graz","Linz","Salzburg"],
      Switzerland: ["Z√ºrich","Genf","Basel","Bern"],
      Belgium: ["Brussels","Antwerp","Ghent","Li√®ge"],
      Netherlands: ["Amsterdam","Rotterdam","The Hague","Utrecht"],
      Azerbaijan: ["Bakƒ±","G…ônc…ô","Sumqayƒ±t"],
      Qatar: ["Doha","Al Wakrah"],
      Kuwait: ["Kuwait City"],
      "United Arab Emirates": ["Dubai","Abu Dhabi","Sharjah"],
  "Saudi Arabia": ["Makkah","Madinah","Riyadh","Jeddah","Dammam"],
    };

    // Fallback country list (used when API or cache fails)
    const STATIC_COUNTRIES = [
      { name: "Germany", iso2: "DE" },
      { name: "T√ºrkiye", iso2: "TR" },
      { name: "Austria", iso2: "AT" },
      { name: "Switzerland", iso2: "CH" },
      { name: "France", iso2: "FR" },
      { name: "Belgium", iso2: "BE" },
      { name: "Netherlands", iso2: "NL" },
      { name: "United Kingdom", iso2: "GB" },
      { name: "United States", iso2: "US" },
      { name: "Canada", iso2: "CA" },
      { name: "Qatar", iso2: "QA" },
      { name: "Kuwait", iso2: "KW" },
      { name: "United Arab Emirates", iso2: "AE" },
      { name: "Saudi Arabia", iso2: "SA" },
      { name: "Morocco", iso2: "MA" },
      { name: "Algeria", iso2: "DZ" },
      { name: "Tunisia", iso2: "TN" },
      { name: "Azerbaijan", iso2: "AZ" },
      { name: "Malaysia", iso2: "MY" },
      { name: "Indonesia", iso2: "ID" },
      { name: "Pakistan", iso2: "PK" },
      { name: "India", iso2: "IN" },
      { name: "Russia", iso2: "RU" },
      { name: "Spain", iso2: "ES" },
      { name: "Italy", iso2: "IT" }
    ];

    function populateCitySelect(countryName) {
      const citySelect = document.getElementById('citySelect');
      const cityInput = document.getElementById('cityInput');
      if (!citySelect || !cityInput) return;
      const list = STATIC_CITIES[countryName];
      if (!list) {
        // Keine bekannte Liste: nur manuelle Eingabe
        citySelect.style.display = 'none';
        cityInput.style.display = 'block';
        return;
      }
      // Liste vorhanden: Select anzeigen, mit Option f√ºr manuelle Eingabe
      citySelect.style.display = 'block';
      while (citySelect.firstChild) citySelect.removeChild(citySelect.firstChild);
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = '-- Stadt ausw√§hlen --';
      citySelect.appendChild(placeholder);
      for (const city of list) {
        const opt = document.createElement('option');
        opt.value = city;
        opt.textContent = city;
        citySelect.appendChild(opt);
      }
      // Manuelle Option hinzuf√ºgen
      const manualOpt = document.createElement('option');
      manualOpt.value = '__manual__';
      manualOpt.textContent = 'Andere Stadt‚Ä¶ (manuell eingeben)';
      citySelect.appendChild(manualOpt);
      // Preselect previously chosen city if in list
      if (currentCity && list.includes(currentCity)) {
        citySelect.value = currentCity;
        cityInput.style.display = 'none';
      } else if (currentCity) {
        // Nicht in Liste: manuell vorausw√§hlen und Feld zeigen
        citySelect.value = '__manual__';
        cityInput.style.display = 'block';
        cityInput.value = currentCity;
      } else {
        cityInput.style.display = 'none';
      }
    }

    function loadCountriesFromCache() {
      try {
        const raw = localStorage.getItem(LS_KEYS.countriesCache);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || !parsed.ts || !Array.isArray(parsed.data)) return null;
        const isFresh = Date.now() - parsed.ts < COUNTRIES_CACHE_TTL_MS;
        if (!isFresh) return null;
        if (!parsed.data || parsed.data.length === 0) return null; // ignore empty cache
        return parsed.data;
      } catch (e) {
        console.warn("Countries cache read failed", e);
        return null;
      }
    }

    function saveCountriesToCache(data) {
      try {
        localStorage.setItem(
          LS_KEYS.countriesCache,
          JSON.stringify({ ts: Date.now(), data })
        );
      } catch (e) {
        console.warn("Countries cache write failed", e);
      }
    }

    async function getAllCountries() {
      const cached = loadCountriesFromCache();
      if (cached && cached.length > 0) return cached;
      try {
        const fresh = await fetchCountriesFromAPI();
        if (fresh && fresh.length > 0) {
          saveCountriesToCache(fresh);
          return fresh;
        }
      } catch (e) {
        console.warn('Countries API fetch failed, using static fallback list', e);
      }
      return STATIC_COUNTRIES;
    }

    function populateCountrySelect(list) {
      const sel = document.getElementById('countrySelect');
      if (!sel) return;
      const previous = currentCountry;
      // Clear except placeholder
      while (sel.firstChild) sel.removeChild(sel.firstChild);
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.dataset.iso = '';
      placeholder.textContent = '-- Land ausw√§hlen --';
      sel.appendChild(placeholder);
      for (const item of list) {
        const opt = document.createElement('option');
        opt.value = item.name;
        opt.dataset.iso = item.iso2 || '';
        opt.textContent = item.iso2 ? `${item.name} (${item.iso2})` : item.name;
        sel.appendChild(opt);
      }
      // Preselect saved country if present
      if (previous) {
        const match = Array.from(sel.options).find(o => o.value.toLowerCase() === previous.toLowerCase());
        if (match) sel.value = match.value;
      }
    }

    function loadSettings() {
      try {
        const savedMode = localStorage.getItem(LS_KEYS.mode);
        const savedCity = localStorage.getItem(LS_KEYS.city);
        const savedCountry = localStorage.getItem(LS_KEYS.country);
        const savedCoords = localStorage.getItem(LS_KEYS.coords);
        const savedMethod = localStorage.getItem(LS_KEYS.method);
        const savedControlsCollapsed = localStorage.getItem(LS_KEYS.controlsCollapsed);

        if (savedMode) currentMode = savedMode;
        if (savedCity) currentCity = savedCity;
        if (savedCountry) currentCountry = savedCountry;
        if (savedCoords) currentCoords = JSON.parse(savedCoords);
        if (savedMethod) calcMethod = parseInt(savedMethod, 10);
        if (savedControlsCollapsed !== null) controlsCollapsed = JSON.parse(savedControlsCollapsed);
      } catch (e) {
        console.warn("Could not load settings:", e);
      }
    }

    function saveSettings() {
      try {
        localStorage.setItem(LS_KEYS.mode, currentMode);
        localStorage.setItem(LS_KEYS.city, currentCity || "");
        localStorage.setItem(LS_KEYS.country, currentCountry || "");
        localStorage.setItem(LS_KEYS.method, String(calcMethod));
        localStorage.setItem(LS_KEYS.controlsCollapsed, JSON.stringify(controlsCollapsed));
        if (currentCoords) {
          localStorage.setItem(LS_KEYS.coords, JSON.stringify(currentCoords));
        }
      } catch (e) {
        console.warn("Could not save settings:", e);
      }
    }

    function toggleControls() {
      const controlsEl = document.getElementById('controls');
      const toggleEl = document.getElementById('controlsToggle');
      
      controlsCollapsed = !controlsCollapsed;
      
      if (controlsCollapsed) {
        controlsEl.classList.add('collapsed');
        toggleEl.classList.add('collapsed');
      } else {
        controlsEl.classList.remove('collapsed');
        toggleEl.classList.remove('collapsed');
      }
      
      saveSettings();
    }

    // Get location from Android if available
    function getLocationFromAndroid() {
      try {
        if (typeof AndroidLocation !== 'undefined') {
          const cityFromAndroid = AndroidLocation.getCity();
          const countryFromAndroid = AndroidLocation.getCountry();

          if (cityFromAndroid && countryFromAndroid) {
            currentCity = cityFromAndroid;
            currentCountry = countryFromAndroid;
            console.log(`Location from Android: ${currentCity}, ${currentCountry}`);
          } else {
            console.log("AndroidLocation returned empty values, using defaults");
          }
          if (currentMode === 'city') updateLocationDisplay();
        } else {
          console.log("AndroidLocation interface not available, using defaults");
          if (currentMode === 'city') updateLocationDisplay();
        }
      } catch (e) {
        console.error("Error getting location from Android:", e);
        console.log("Using default location: Berlin, Germany");
        if (currentMode === 'city') updateLocationDisplay();
      }
    }

    function updateLocationDisplay() {
      const locationDisplay = document.getElementById("locationDisplay");
      if (locationDisplay) {
        if (currentMode === 'coords' && currentCoords) {
          locationDisplay.textContent = `üìç GPS: ${currentCoords.lat.toFixed(4)}, ${currentCoords.lon.toFixed(4)}`;
          return;
        }
        // Map common country names to their local variants
        const countryDisplayMap = {
          "Germany": "Almanya",
          "Turkey": "T√ºrkiye",
          "T√ºrkiye": "T√ºrkiye",
          "Austria": "Avusturya",
          "Netherlands": "Hollanda",
          "France": "Fransa",
          "Belgium": "Bel√ßika",
          "Switzerland": "ƒ∞svi√ßre"
        };
        const countryDisplay = countryDisplayMap[currentCountry] || currentCountry;
        locationDisplay.textContent = `üìç ${currentCity}, ${countryDisplay}`;
      }
    }

    function setStatus(status) {
      const indicator = document.getElementById("statusIndicator");
      indicator.className = `status-indicator ${status}`;
    }

    async function fetchPrayerTimes() {
      console.log("fetchPrayerTimes started");
      setStatus("loading");
      try {
        let apiUrl = "";
        let response;
        if (currentMode === 'coords' && currentCoords) {
          const { lat, lon } = currentCoords;
          apiUrl = `https://api.aladhan.com/v1/timings?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&method=${encodeURIComponent(calcMethod)}`;
        } else {
          // Use location from Android or defaults
          const encodedCity = encodeURIComponent(currentCity);
          const encodedCountry = encodeURIComponent(currentCountry);
          apiUrl = `https://api.aladhan.com/v1/timingsByCity?city=${encodedCity}&country=${encodedCountry}&method=${encodeURIComponent(calcMethod)}`;
        }
        console.log(`Fetching from: ${apiUrl}`);

        response = await fetch(apiUrl);
        console.log(`Response status: ${response.status}`);

        if (!response.ok)
          throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        console.log("Data received:", data);

        if (data.code !== 200) throw new Error("API returned error");

        const timings = data.data.timings;
        const date = data.data.date;

        const dayNamesDE = {
          Monday: "Montag",
          Tuesday: "Dienstag",
          Wednesday: "Mittwoch",
          Thursday: "Donnerstag",
          Friday: "Freitag",
          Saturday: "Samstag",
          Sunday: "Sonntag",
        };

        const monthNamesDE = {
          January: "Januar",
          February: "Februar",
          March: "M√§rz",
          April: "April",
          May: "Mai",
          June: "Juni",
          July: "Juli",
          August: "August",
          September: "September",
          October: "Oktober",
          November: "November",
          December: "Dezember",
        };

        const gregDay = String(date.gregorian.day).padStart(2, "0");
        const gregMonth = monthNamesDE[date.gregorian.month.en] || date.gregorian.month.en;
        const gregYear = date.gregorian.year;
        const gregWeekday = date.gregorian.weekday.en;

        const hijriWeekday = date.hijri.weekday.ar;
        const hijriMonth = date.hijri.month.ar;
        const hijriYear = date.hijri.year;

        prayerData = {
          gregorian: `${gregDay}. ${gregMonth} ${gregYear}`,
          weekday: dayNamesDE[gregWeekday] || gregWeekday,
          hijri: `${date.hijri.day} ${hijriMonth} ${hijriYear}`,
          imsak: timings.Fajr || timings.Imsak,
          gunes: timings.Sunrise,
          ogle: timings.Dhuhr,
          ikindi: timings.Asr,
          aksam: timings.Maghrib,
          yatsi: timings.Isha,
        };

        displayPrayerTimes(prayerData);
        setStatus("success");
        console.log("Prayer times displayed successfully");
      } catch (err) {
        console.error("Error fetching prayer times:", err);
        console.error("Error details:", err.message, err.stack);
        setStatus("error");
        showError(`Namaz vakitleri y√ºklenirken hata olu≈ütu: ${err.message}`);
      }
    }

    function displayPrayerTimes(data) {
      document.getElementById("gregorianDate").textContent = `${
        data.weekday || ""
      } ${data.gregorian}`;
      document.getElementById("hijriDate").textContent = data.hijri;

      const html = `
    <div class="prayer-card" data-prayer="imsak">
      <div class="prayer-name">ÿßŸÑŸÅÿ¨ÿ±</div>
      <div class="prayer-time">${data.imsak}</div>
    </div>
    <div class="prayer-card" data-prayer="gunes">
      <div class="prayer-name">ÿßŸÑÿ¥ÿ±ŸàŸÇ</div>
      <div class="prayer-time">${data.gunes}</div>
    </div>
    <div class="prayer-card" data-prayer="ogle">
      <div class="prayer-name">ÿßŸÑÿ∏Ÿáÿ±</div>
      <div class="prayer-time">${data.ogle}</div>
    </div>
    <div class="prayer-card" data-prayer="ikindi">
      <div class="prayer-name">ÿßŸÑÿπÿµÿ±</div>
      <div class="prayer-time">${data.ikindi}</div>
    </div>
    <div class="prayer-card" data-prayer="aksam">
      <div class="prayer-name">ÿßŸÑŸÖÿ∫ÿ±ÿ®</div>
      <div class="prayer-time">${data.aksam}</div>
    </div>
    <div class="prayer-card" data-prayer="yatsi">
      <div class="prayer-name">ÿßŸÑÿπÿ¥ÿßÿ°</div>
      <div class="prayer-time">${data.yatsi}</div>
    </div>
  `;
      document.getElementById("prayerTimesGrid").innerHTML = html;
      startCountdown();
    }

    function showError(message) {
      document.getElementById("prayerTimesGrid").innerHTML = `
    <div class="error">
      ${message}
      <br><br>
      <button class="refresh-button" onclick="fetchPrayerTimes()">Tekrar Dene</button>
    </div>
  `;
    }

    function parseTime(t) {
      if (!t || t === "--") return { h: 0, m: 0, total: 0 };
      const [h, m] = t.split(":").map(Number);
      return { h, m, total: h * 60 + m };
    }

    function startCountdown() {
      if (countdownInterval) clearInterval(countdownInterval);

      function update() {
        if (!prayerData) return;

        const now = new Date();
        const nowMinutes = now.getHours() * 60 + now.getMinutes();

        const prayers = [
          { name: "ÿßŸÑŸÅÿ¨ÿ±", key: "imsak", ...parseTime(prayerData.imsak) },
          { name: "ÿßŸÑÿ¥ÿ±ŸàŸÇ", key: "gunes", ...parseTime(prayerData.gunes) },
          { name: "ÿßŸÑÿ∏Ÿáÿ±", key: "ogle", ...parseTime(prayerData.ogle) },
          { name: "ÿßŸÑÿπÿµÿ±", key: "ikindi", ...parseTime(prayerData.ikindi) },
          { name: "ÿßŸÑŸÖÿ∫ÿ±ÿ®", key: "aksam", ...parseTime(prayerData.aksam) },
          { name: "ÿßŸÑÿπÿ¥ÿßÿ°", key: "yatsi", ...parseTime(prayerData.yatsi) },
        ];

        let currentPrayer = null;
        let nextPrayer = null;

        // Determine current (last <= now) and next (> now)
        for (const p of prayers) {
          if (p.total <= nowMinutes) {
            currentPrayer = p;
          } else if (!nextPrayer) {
            nextPrayer = p;
          }
        }
        let nextIsTomorrow = false;

        // Before first prayer (no current)
        if (!currentPrayer && nextPrayer) {
          // only upcoming highlight
        }

        // After last prayer
        if (!nextPrayer) {
          nextPrayer = prayers[0];
          nextIsTomorrow = true;
        }

        // Apply highlighting
        document
          .querySelectorAll(".prayer-card")
          .forEach((el) => el.classList.remove("active", "upcoming"));

        if (currentPrayer) {
          const curEl = document.querySelector(
            `[data-prayer="${currentPrayer.key}"]`
          );
          if (curEl) curEl.classList.add("active");
        }

        if (
          nextPrayer &&
          (!currentPrayer || currentPrayer.key !== nextPrayer.key)
        ) {
          const nextEl = document.querySelector(
            `[data-prayer="${nextPrayer.key}"]`
          );
          if (nextEl) nextEl.classList.add("upcoming");
        }

        // Countdown calculation using Date objects for accuracy
        const nextDate = new Date(now);
        if (nextIsTomorrow) nextDate.setDate(nextDate.getDate() + 1);
        nextDate.setHours(nextPrayer.h, nextPrayer.m, 0, 0);

        const diffMs = nextDate - now;
        const diffSec = Math.max(0, Math.floor(diffMs / 1000));
        const hours = Math.floor(diffSec / 3600);
        const minutes = Math.floor((diffSec % 3600) / 60);
        const seconds = diffSec % 60;

        document.getElementById("countdownTimer").textContent = `${String(
          hours
        ).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(
          seconds
        ).padStart(2, "0")}`;

        // Info text
        document.getElementById(
          "nextPrayerInfo"
        ).innerHTML = `<strong style="color:#ef4444;text-shadow:0 0 8px rgba(96,165,250,0.3);">${nextPrayer.name}</strong><br>
       <span style="font-size:0.7em;opacity:0.9;color:#94a3b8;">NAMAZINA QALAN VAXT</span>`;

        // Update current clock
        document.getElementById("currentTime").textContent =
          `${String(now.getHours()).padStart(2, "0")}:` +
          `${String(now.getMinutes()).padStart(2, "0")}:` +
          `${String(now.getSeconds()).padStart(2, "0")}`;
      }

      update();
      countdownInterval = setInterval(update, 1000);
    }

    // Initialize
    window.addEventListener("load", function() {
      // Load saved
      loadSettings();
      
      // Apply initial collapsed state
      if (controlsCollapsed) {
        document.getElementById('controls').classList.add('collapsed');
        document.getElementById('controlsToggle').classList.add('collapsed');
      }
      
      // Wire UI initial values
  const countrySel = document.getElementById('countrySelect');
  const citySel = document.getElementById('citySelect');
  const cityEl = document.getElementById('cityInput');
      const methodEl = document.getElementById('methodSelect');
      const modeEl = document.getElementById('modeSelect');
  // Country will be selected after options are populated
  if (cityEl) cityEl.value = currentCity || '';
      if (methodEl) methodEl.value = String(calcMethod);
      if (modeEl) modeEl.value = currentMode;

      // Load countries list (cached 24h) and populate select + cities
      (async () => {
        try {
          const countries = await getAllCountries();
          // Use fetched or fallback list
          populateCountrySelect(countries && countries.length ? countries : STATIC_COUNTRIES);
        } catch (e) {
          console.warn('Loading countries failed; using static fallback list', e);
          populateCountrySelect(STATIC_COUNTRIES);
        } finally {
          // After country options are ready: select saved country and populate city control
          if (countrySel && (countrySel.value || currentCountry)) {
            if (!countrySel.value && currentCountry) countrySel.value = currentCountry;
            populateCitySelect(countrySel.value || currentCountry);
          }
        }
      })();

      // Events
      document.getElementById('controlsToggle').addEventListener('click', toggleControls);

      document.getElementById('applyBtn').addEventListener('click', () => {
        const ctry = (countrySel && countrySel.value ? countrySel.value : '').trim();
        // City value: prefer select if visible
        const isCitySelectVisible = citySel && getComputedStyle(citySel).display !== 'none';
        let cty;
        if (isCitySelectVisible) {
          const selVal = (citySel.value || '').trim();
          cty = selVal === '__manual__' ? (cityEl.value || '').trim() : selVal;
        } else {
          cty = (cityEl.value || '').trim();
        }
        calcMethod = parseInt(methodEl.value, 10) || 13;
        currentMode = modeEl.value;
        if (currentMode === 'city') {
          if (!cty || !ctry) {
            showError('L√ºtfen ≈üehir ve √ºlke giriniz.');
            return;
          }
          currentCity = cty;
          currentCountry = ctry;
          currentCoords = null;
          updateLocationDisplay();
        }
        saveSettings();
        fetchPrayerTimes();
        
        // Auto-close controls after applying
        controlsCollapsed = true;
        document.getElementById('controls').classList.add('collapsed');
        document.getElementById('controlsToggle').classList.add('collapsed');
        saveSettings();
      });

      document.getElementById('gpsBtn').addEventListener('click', () => {
        requestGPS();
      });

      if (countrySel) {
        countrySel.addEventListener('change', () => {
          const selCountry = countrySel.value;
          // Reset city value
          if (cityEl) cityEl.value = '';
          if (citySel) citySel.value = '';
          populateCitySelect(selCountry);
        });
      }

      // Umschalten auf manuelle Eingabe, wenn entsprechende Option gew√§hlt wurde
      if (citySel) {
        citySel.addEventListener('change', () => {
          if (!cityEl) return;
          const manual = citySel.value === '__manual__';
          cityEl.style.display = manual ? 'block' : 'none';
        });
      }

      // If city mode and nothing saved, try Android
      if (currentMode === 'city' && (!currentCity || !currentCountry)) {
        getLocationFromAndroid();
      }
      // Display initial location and fetch
      updateLocationDisplay();
      fetchPrayerTimes();
    });

    // Refresh times every 6 hours
    setInterval(fetchPrayerTimes, 6 * 60 * 60 * 1000);

    // Refresh at midnight
    function scheduleMidnightRefresh() {
      const now = new Date();
      const tomorrow = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate() + 1,
        0,
        0,
        5
      );
      const ms = tomorrow - now;
      setTimeout(() => {
        fetchPrayerTimes();
        scheduleMidnightRefresh();
      }, ms);
    }
    scheduleMidnightRefresh();

    // GPS handling
    function requestGPS() {
      if (!('geolocation' in navigator)) {
        showError('Bu cihazda GPS kullanƒ±mƒ± desteklenmiyor.');
        return;
      }
      setStatus('loading');
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          currentCoords = { lat: latitude, lon: longitude };
          currentMode = 'coords';
          saveSettings();
          updateLocationDisplay();
          fetchPrayerTimes();
          
          // Auto-close controls after GPS
          controlsCollapsed = true;
          document.getElementById('controls').classList.add('collapsed');
          document.getElementById('controlsToggle').classList.add('collapsed');
          saveSettings();
        },
        (err) => {
          console.error('GPS error', err);
          let msg = 'GPS konumu alƒ±namadƒ±.';
          if (err.code === 1) msg = 'GPS izni reddedildi.';
          else if (err.code === 2) msg = 'Konum bilgisi kullanƒ±lamƒ±yor.';
          else if (err.code === 3) msg = 'GPS isteƒüi zaman a≈üƒ±mƒ±na uƒüradƒ±.';
          showError(msg);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }
</script>
</body>
</html>
