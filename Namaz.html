<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https: https://api.aladhan.com;">
    <title>NAMAZ VAKTƒ∞</title>
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        :root {
          --bg-0: #0b0f14;
          --bg-1: #0a0d12;
          --bg-2: #0c1118;
          --panel: rgba(10, 14, 20, 0.92);
          --panel-soft: rgba(13, 19, 28, 0.7);
          --card: rgba(14, 21, 31, 0.85);
          --text: #e5e7eb;
          --muted: #94a3b8;
          --accent: #60a5fa;
          --accent-strong: #3b82f6;
          --accent-soft: rgba(37, 99, 235, 0.18);
          --danger: #ef4444;
          --border: rgba(255, 255, 255, 0.05);
          --border-strong: rgba(59, 130, 246, 0.6);
          --active-green-base: #22c55e;
          --active-green-bright: #41ff9d;
          /* Variablen f√ºr Logo-Hintergrund (leicht dunkler, nicht mehr reines Wei√ü) */
          --logo-bg-start: #d3d9e0; /* helles ged√§mpftes Grau-Blau */
          --logo-bg-end: #9aaabd;   /* dunklerer Verlaufsausgang */
          color-scheme: dark;
        }

        body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          background: linear-gradient(135deg, var(--bg-0) 0%, var(--bg-1) 40%, var(--bg-2) 100%);
          color: var(--text);
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 10px;
          -webkit-tap-highlight-color: transparent;
          overflow-x: hidden;
        }

        .prayer-app {
          width: 100%;
          max-width: 420px;
          background: transparent;
          border-radius: 20px;
          padding: 20px;
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        .header {
          text-align: center;
        }

        .app-title {
          font-size: clamp(28px, 5vw, 24px);
          font-weight: 600;
          color: var(--accent);
          margin-bottom: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          letter-spacing: 0.2px;
          flex-wrap: wrap;
        }

        .location {
          font-size: clamp(13px, 3.5vw, 14px);
          color: var(--muted);
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 5px;
          flex-wrap: wrap;
        }

        .status-indicator {
          display: inline-block;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          animation: pulse 2s infinite;
          flex-shrink: 0;
        }
        .status-indicator.loading { background-color: #fbbf24; }
        .status-indicator.success { background-color: #10b981; }
        .status-indicator.error { background-color: var(--danger); }

        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }

        .controls-row {
          display: flex;
          gap: 8px;
          flex-wrap: wrap;
        }

        .location-controls {
          display: flex;
          gap: 8px;
          padding: 12px;
          background: var(--panel-soft);
          border-radius: 15px;
          border: 1px solid var(--border);
          flex: 1;
          min-width: 200px;
        }

        .settings-btn {
          padding: 10px 16px;
          background: var(--card);
          color: var(--text);
          border: 1px solid var(--border);
          border-radius: 10px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
        }

        .settings-btn:hover {
          background: var(--accent-soft);
          border-color: var(--accent);
        }

        .settings-btn.active {
          background: var(--accent);
          color: var(--bg-0);
        }

        /* Bismillah Bild √ºber dem Titel */
        .bismillah {
          display: block;
          margin: 0 auto 10px auto;
          width: clamp(140px, 45%, 260px);
          height: auto;
          filter: drop-shadow(0 2px 6px rgba(0,0,0,0.5));
          user-select: none;
          -webkit-user-drag: none;
        }

        /* √úbernommene Glow-Rahmen Styles aus logo.html */
        .glow-wrapper {
          position: relative;
          display: inline-block;
          padding: 0; /* Rahmen direkt am Bild */
          border-radius: 12px; /* leicht gr√∂√üer als Bildradius */
          overflow: hidden;
          /* Deutlich weniger Wei√ü: k√ºhler Grau-Blau Verlauf statt reinem Wei√ü */
          background: radial-gradient(circle at center, var(--logo-bg-start) 0%, var(--logo-bg-end) 100%);
          border: 3px solid rgba(100, 200, 255, 0.55);
          box-shadow:
            0 0 12px rgba(120, 200, 255, 0.6),
            inset 0 0 18px rgba(255, 255, 255, 0.35);
          animation: frameGlow 3.2s ease-in-out infinite;
          line-height: 0;
          margin: 0 auto 14px auto; /* Abstand unter dem Bild */
        }

        .basmalah-img {
          display: block;
          width: clamp(160px, 55%, 300px);
          max-width: 100%;
          height: auto;
          border-radius: 10px;
          /* Bild minimal abdunkeln, damit Wei√ü nicht blendet */
          filter: brightness(0.92) drop-shadow(0 0 10px rgba(50, 150, 255, 0.35));
          transition: transform 0.35s ease, filter 0.35s ease;
        }

        .basmalah-img:hover {
          transform: scale(1.03);
          filter: brightness(0.97) drop-shadow(0 0 16px rgba(50, 150, 255, 0.55));
        }

        @keyframes frameGlow {
          0%, 100% {
            box-shadow:
              0 0 16px rgba(120, 200, 255, 0.85),
              0 0 34px rgba(80, 170, 240, 0.55),
              inset 0 0 22px rgba(255, 255, 255, 0.65);
          }
            50% {
            box-shadow:
              0 0 26px rgba(120, 200, 255, 0.9),
              0 0 48px rgba(80, 170, 240, 0.7),
              inset 0 0 28px rgba(255, 255, 255, 0.8);
          }
        }

        .location-btn {
          flex: 1;
          min-width: 100px;
          padding: 10px 16px;
          background: var(--card);
          color: var(--text);
          border: 1px solid var(--border);
          border-radius: 10px;
          cursor: pointer;
          font-size: clamp(13px, 3.5vw, 14px);
          font-weight: 600;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
        }

        .location-btn:hover {
          background: var(--accent-soft);
          border-color: var(--accent);
        }

        .location-btn.active {
          background: var(--accent);
          color: var(--bg-0);
          border-color: var(--accent-strong);
        }

        .location-selector {
          display: none;
          padding: 16px;
          background: var(--panel-soft);
          border-radius: 15px;
          border: 1px solid var(--border);
          gap: 12px;
          flex-direction: column;
        }

        .location-selector.active {
          display: flex;
        }

        .settings-panel {
          display: none;
          padding: 16px;
          background: var(--panel-soft);
          border-radius: 15px;
          border: 1px solid var(--border);
          gap: 12px;
          flex-direction: column;
        }

        .settings-panel.active {
          display: flex;
        }

        .setting-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px;
          background: var(--card);
          border-radius: 10px;
          border: 1px solid var(--border);
        }

        .setting-label {
          font-size: 14px;
          font-weight: 500;
          color: var(--text);
        }

        .toggle-switch {
          width: 50px;
          height: 28px;
          background: var(--accent-soft);
          border-radius: 14px;
          cursor: pointer;
          position: relative;
          border: 1px solid var(--accent);
          transition: all 0.2s ease;
        }

        .toggle-switch.active {
          background: var(--active-green-base);
        }

        .toggle-switch::after {
          content: "";
          position: absolute;
          width: 24px;
          height: 24px;
          background: white;
          border-radius: 50%;
          top: 2px;
          left: 2px;
          transition: left 0.2s ease;
        }

        .toggle-switch.active::after {
          left: 24px;
        }

        .search-box {
          width: 100%;
          padding: 12px 16px;
          background: var(--card);
          color: var(--text);
          border: 1px solid var(--border);
          border-radius: 10px;
          font-size: clamp(13px, 3.5vw, 14px);
          outline: none;
          transition: all 0.2s ease;
        }

        .search-box:focus {
          border-color: var(--accent);
          box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .city-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
          gap: 8px;
          max-height: 400px;
          overflow-y: auto;
          padding: 4px;
        }

        .no-results {
          grid-column: 1 / -1;
          text-align: center;
          padding: 20px;
          color: var(--muted);
          font-size: 14px;
        }

        .city-btn {
          padding: 12px;
          background: var(--card);
          color: var(--text);
          border: 1px solid var(--border);
          border-radius: 8px;
          cursor: pointer;
          font-size: clamp(12px, 3vw, 13px);
          font-weight: 500;
          transition: all 0.2s ease;
          text-align: center;
        }

        .city-btn:hover {
          background: var(--accent-soft);
          border-color: var(--accent);
          transform: translateY(-2px);
        }

        .city-btn.selected {
          background: var(--accent);
          color: var(--bg-0);
          border-color: var(--accent-strong);
        }

        .date-section {
          text-align: center;
          padding: 12px;
          background: var(--panel-soft);
          border-radius: 15px;
          border: 1px solid var(--border);
        }

        .gregorian-date {
          font-size: clamp(16px, 4.5vw, 18px);
          font-weight: 600;
          color: var(--accent);
          margin-bottom: 5px;
          line-height: 1.3;
        }

        .hijri-date {
          font-size: clamp(12px, 3.5vw, 14px);
          color: var(--muted);
          line-height: 1.3;
        }

        .current-time-section {
          text-align: center;
          padding: 16px 12px;
          background: var(--panel-soft);
          border-radius: 15px;
          border: 1px solid var(--border);
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .current-time {
          font-size: clamp(32px, 10vw, 40px);
          font-weight: bold;
          color: var(--accent);
          text-shadow: 0 0 10px rgba(96, 165, 250, 0.15);
          font-variant-numeric: tabular-nums;
          line-height: 1;
        }

        .next-prayer-info {
          font-size: clamp(18px, 4vw, 20px);
          color: var(--muted);
          line-height: 1.2;
          font-weight: 500;
        }

        .countdown-timer {
          font-size: clamp(22px, 6vw, 32px);
          font-weight: 700;
          color: var(--danger);
          font-variant-numeric: tabular-nums;
          letter-spacing: 1px;
        }

        .prayer-times-grid {
          display: grid;
          grid-template-columns: repeat(3, minmax(0, 1fr));
          gap: 10px;
        }

        .prayer-card {
          position: relative;
          isolation: isolate;
          background: var(--card);
          border-radius: 12px;
          padding: 16px 12px;
          text-align: center;
          transition: all 0.25s ease;
          border: 1px solid var(--border);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          min-height: 80px;
          overflow: hidden;
          cursor: pointer;
        }

        .prayer-card:hover {
          transform: translateY(-2px);
        }

        .prayer-name {
          font-size: clamp(16px, 3.5vw, 18px);
          font-weight: 600;
          color: var(--muted);
          margin-bottom: 6px;
          letter-spacing: 0.5px;
          text-shadow: 0 0 8px rgba(96, 165, 250, 0.5);
        }

        .prayer-time {
          font-size: clamp(20px, 5vw, 24px);
          font-weight: 700;
          color: var(--text);
          font-variant-numeric: tabular-nums;
          letter-spacing: 0.5px;
        }

        .prayer-card.active {
          background: radial-gradient(circle at 50% 40%, rgba(34, 197, 94, 0.3), rgba(14, 21, 31, 0.92) 70%);
          border: 1px solid var(--active-green-base);
          box-shadow: 0 0 1px 1px rgba(34, 197, 94, 0.75), 0 0 9px 3px rgba(134, 245, 175, 0.55), 0 0 2px 5px rgba(34, 197, 94, 0.35), inset 0 0 8px rgba(34, 197, 94, 0.28);
          transform: translateY(-2px) scale(1);
          transition: all 0.45s cubic-bezier(0.25, 0.6, 0.3, 1);
          backdrop-filter: blur(2px) saturate(135%);
        }

        .prayer-card.active::before {
          content: "";
          position: absolute;
          inset: -10px;
          border-radius: 16px;
          background: radial-gradient(circle at 50% 55%, rgba(34, 197, 94, 0.55), transparent 60%), radial-gradient(circle at 30% 30%, rgba(34, 197, 94, 0.35), transparent 70%);
          opacity: 0.55;
          filter: blur(15px);
          animation: activeAura 5s ease-in-out infinite;
          z-index: -1;
          pointer-events: none;
        }

        @keyframes activeAura {
          0%, 100% { opacity: 0.45; transform: scale(1); }
          50% { opacity: 0.85; transform: scale(1.06); }
        }

        .prayer-card.active .prayer-name {
          color: #ffffff;
          font-size: clamp(16px, 6.5vw, 20px);
          font-weight: 900;
          background: rgba(0, 0, 0, 0.75);
          padding: 6px 14px;
          border-radius: 999px;
          border: 1px solid rgba(65, 255, 157, 0.35);
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }

        .prayer-card.active .prayer-time {
          color: #ffffff;
          font-size: clamp(20px, 8vw, 30px);
          font-weight: 800;
          background: rgba(0, 0, 0, 0.75);
          padding: 10px 18px;
          border-radius: 18px;
          border: 1px solid rgba(65, 255, 157, 0.35);
          margin-top: 10px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
        }

        .prayer-card.upcoming {
          background: linear-gradient(145deg, rgba(4, 82, 177, 0.412), rgba(14, 21, 31, 0.92));
          border: 2px solid #d4a006b3;
          transform: translateY(-2px) scale(1.05);
          transition: all 0.45s cubic-bezier(0.25, 0.6, 0.3, 1);
        }

        .prayer-card.upcoming::before {
          content: "";
          position: absolute;
          inset: -8px;
          border-radius: 14px;
          opacity: 0.45;
          filter: blur(12px);
          animation: upcomingPulse 6s ease-in-out infinite;
          z-index: -1;
          pointer-events: none;
        }

        @keyframes upcomingPulse {
          0%, 100% { opacity: 0.35; transform: scale(1); }
          50% { opacity: 0.7; transform: scale(1.04); }
        }

        .prayer-card.upcoming .prayer-name,
        .prayer-card.upcoming .prayer-time {
          color: var(--text);
          text-shadow: 0 0 8px #000000;
        }

        .loading {
          text-align: center;
          padding: 30px 20px;
          color: var(--muted);
          font-size: clamp(13px, 3.5vw, 14px);
          grid-column: 1 / -1;
        }

        .error {
          text-align: center;
          padding: 20px 16px;
          color: var(--danger);
          font-size: clamp(13px, 3.5vw, 14px);
          background: rgba(239, 68, 68, 0.1);
          border-radius: 12px;
          border: 1px solid rgba(239, 68, 68, 0.2);
          grid-column: 1 / -1;
          line-height: 1.5;
        }

        .button-group {
          display: flex;
          gap: 8px;
        }

        .action-btn {
          flex: 1;
          background: var(--accent);
          color: var(--bg-0);
          border: none;
          padding: 10px 16px;
          border-radius: 8px;
          cursor: pointer;
          font-size: clamp(13px, 3.5vw, 14px);
          font-weight: 600;
          transition: all 0.2s ease;
        }

        .action-btn:hover {
          background: var(--accent-strong);
          transform: translateY(-1px);
        }

        .action-btn:active {
          transform: scale(0.96);
        }

        .notification-toast {
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: var(--active-green-base);
          color: white;
          padding: 16px 24px;
          border-radius: 10px;
          font-weight: 600;
          animation: slideIn 0.3s ease;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideIn {
          from {
            transform: translateX(400px);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        .method-select {
          width: 100%;
          padding: 10px;
          background: var(--card);
          color: var(--text);
          border: 1px solid var(--border);
          border-radius: 8px;
          font-size: 14px;
          outline: none;
          transition: all 0.2s ease;
        }

        .method-select:focus {
          border-color: var(--accent);
          box-shadow: 0 0 0 3px var(--accent-soft);
        }

        @media (max-width: 360px) {
          .prayer-app { padding: 16px; gap: 12px; }
          .prayer-card { padding: 14px 10px; min-height: 75px; }
          .current-time-section { padding: 14px 10px; }
        }

        @media (min-width: 600px) {
          .prayer-app { padding: 30px 24px; }
          .prayer-times-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
          .current-time { font-size: 42px; }
        }

        @media (min-width: 900px) {
          .prayer-app { max-width: 820px; }
          .prayer-times-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
          .prayer-card { padding: 22px 16px; min-height: 120px; }
          .current-time { font-size: 48px; }
        }
    </style>
</head>
<body>
<div class="prayer-app">
    <div class="header">
  <div class="glow-wrapper">
    <img class="bismillah basmalah-img" src="bismillah.png" alt="Bismillah" loading="eager" decoding="async">
  </div>
        <div class="app-title">
            NAMAZ VAKTƒ∞
            <span class="status-indicator loading" id="statusIndicator"></span>
        </div>
        <div class="location" id="locationDisplay">üìç Berlin, Almanya</div>
    </div>

    <div class="controls-row">
        <div class="location-controls">
            <button class="location-btn" id="gpsBtn">üìç GPS</button>
            <button class="location-btn active" id="cityBtn">üåç Stadt</button>
        </div>
        <button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>
    </div>

    <div class="location-selector" id="citySelector">
        <input type="text" class="search-box" id="searchBox" placeholder="Stadt suchen...">
        <div class="city-grid" id="cityGrid"></div>
    </div>

    <div class="settings-panel" id="settingsPanel">
        <select class="method-select" id="methodSelect">
            <option value="13">Ummah - 13</option>
            <option value="0">Shia - 0</option>
            <option value="1">Hanafi - 1</option>
            <option value="2">Maliki - 2</option>
            <option value="3">Shafi - 3</option>
            <option value="4">Hanbali - 4</option>
            <option value="5">Jafari - 5</option>
            <option value="7">Al Ghad - 7</option>
            <option value="8">University of Islamic Sciences - 8</option>
            <option value="9">Diyanet - 9</option>
            <option value="10">Kuwait - 10</option>
            <option value="11">Qatar - 11</option>
            <option value="12">Majlis Ugama - 12</option>
            <option value="14">UOIF - 14</option>
            <option value="15">JAKIM - 15</option>
        </select>

        <div class="setting-item">
            <span class="setting-label">üîî Benachrichtigungen</span>
            <div class="toggle-switch" id="notificationToggle"></div>
        </div>

        <div class="setting-item">
            <span class="setting-label">üåô Dark Mode</span>
            <div class="toggle-switch active" id="darkModeToggle"></div>
        </div>

        <div class="button-group">
            <button class="action-btn" id="copyTimesBtn">üìã Kopieren</button>
            <button class="action-btn" id="shareBtn">üì§ Teilen</button>
        </div>
    </div>

    <div class="date-section">
        <div class="gregorian-date" id="gregorianDate">Y√ºkleniyor...</div>
        <div class="hijri-date" id="hijriDate">--</div>
    </div>

    <div class="current-time-section">
        <div class="current-time" id="currentTime">--:--:--</div>
        <div class="next-prayer-info" id="nextPrayerInfo">--</div>
        <div class="countdown-timer" id="countdownTimer">--:--:--</div>
    </div>

    <div class="prayer-times-grid" id="prayerTimesGrid">
        <div class="loading">Namaz vakitleri y√ºkleniyor...</div>
    </div>

    <div class="button-group">
        <button class="action-btn" id="refreshBtn">üîÑ Aktualisieren</button>
    </div>
</div>

<script>
    let prayerData = null;
    let countdownInterval = null;
    let currentCity = "Berlin";
    let currentCountry = "Germany";
    let currentLat = null;
    let currentLon = null;
    let useGPS = false;
    let prayerMethod = "13";
    let notificationsEnabled = false;
    let lastNotifiedPrayer = null;

    let cities = [];

    async function loadCitiesFromAPI() {
        try {
            // Umfassende Liste von L√§ndern und St√§dten (200+ St√§dte weltweit)
            const citiesData = [
                // Deutschland
                { name: "Berlin", country: "Germany", display: "Berlin" },
                { name: "Hamburg", country: "Germany", display: "Hamburg" },
                { name: "M√ºnchen", country: "Germany", display: "M√ºnchen" },
                { name: "K√∂ln", country: "Germany", display: "K√∂ln" },
                { name: "Frankfurt", country: "Germany", display: "Frankfurt" },
                { name: "Stuttgart", country: "Germany", display: "Stuttgart" },
                { name: "D√ºsseldorf", country: "Germany", display: "D√ºsseldorf" },
                { name: "Dortmund", country: "Germany", display: "Dortmund" },
                { name: "Essen", country: "Germany", display: "Essen" },
                { name: "Leipzig", country: "Germany", display: "Leipzig" },
                // √ñsterreich
                { name: "Wien", country: "Austria", display: "Wien" },
                { name: "Graz", country: "Austria", display: "Graz" },
                { name: "Salzburg", country: "Austria", display: "Salzburg" },
                // Schweiz
                { name: "Z√ºrich", country: "Switzerland", display: "Z√ºrich" },
                { name: "Bern", country: "Switzerland", display: "Bern" },
                { name: "Genf", country: "Switzerland", display: "Genf" },
                // Niederlande
                { name: "Amsterdam", country: "Netherlands", display: "Amsterdam" },
                { name: "Rotterdam", country: "Netherlands", display: "Rotterdam" },
                { name: "Den Haag", country: "Netherlands", display: "Den Haag" },
                // Belgien
                { name: "Br√ºssel", country: "Belgium", display: "Br√ºssel" },
                { name: "Antwerpen", country: "Belgium", display: "Antwerpen" },
                // Frankreich
                { name: "Paris", country: "France", display: "Paris" },
                { name: "Marseille", country: "France", display: "Marseille" },
                { name: "Lyon", country: "France", display: "Lyon" },
                // UK
                { name: "London", country: "United Kingdom", display: "London" },
                { name: "Manchester", country: "United Kingdom", display: "Manchester" },
                { name: "Birmingham", country: "United Kingdom", display: "Birmingham" },
                // T√ºrkei
                { name: "Istanbul", country: "Turkey", display: "Istanbul" },
                { name: "Ankara", country: "Turkey", display: "Ankara" },
                { name: "Izmir", country: "Turkey", display: "ƒ∞zmir" },
                { name: "Bursa", country: "Turkey", display: "Bursa" },
                { name: "Antalya", country: "Turkey", display: "Antalya" },
                // Mittlerer Osten
                { name: "Dubai", country: "United Arab Emirates", display: "Dubai" },
                { name: "Abu Dhabi", country: "United Arab Emirates", display: "Abu Dhabi" },
                { name: "Cairo", country: "Egypt", display: "Kahire" },
                { name: "Alexandria", country: "Egypt", display: "ƒ∞skenderiye" },
                { name: "Riyadh", country: "Saudi Arabia", display: "Riyad" },
                { name: "Jeddah", country: "Saudi Arabia", display: "Cidde" },
                { name: "Mecca", country: "Saudi Arabia", display: "Mekke" },
                { name: "Medina", country: "Saudi Arabia", display: "Medine" },
                { name: "Kuwait City", country: "Kuwait", display: "Kuveyt" },
                { name: "Doha", country: "Qatar", display: "Doha" },
                { name: "Manama", country: "Bahrain", display: "Bahreyn" },
                // Indien & Pakistan
                { name: "Mumbai", country: "India", display: "Mumbai" },
                { name: "Delhi", country: "India", display: "Yeni Delhi" },
                { name: "Karachi", country: "Pakistan", display: "Kara√ßi" },
                { name: "Lahore", country: "Pakistan", display: "Lahor" },
                { name: "Islamabad", country: "Pakistan", display: "ƒ∞slamabad" },
                // Malaysia & Singapur
                { name: "Kuala Lumpur", country: "Malaysia", display: "Kuala Lumpur" },
                { name: "Singapore", country: "Singapore", display: "Singapur" },
                // Indonesien
                { name: "Jakarta", country: "Indonesia", display: "Jakarta" },
                { name: "Bandung", country: "Indonesia", display: "Bandung" },
                // Marokko & Tunesien
                { name: "Casablanca", country: "Morocco", display: "Kasablanka" },
                { name: "Fez", country: "Morocco", display: "Fes" },
                { name: "Tunis", country: "Tunisia", display: "Tunus" },
                // Albanien & Bosnien
                { name: "Tirana", country: "Albania", display: "Tiran" },
                { name: "Sarajevo", country: "Bosnia and Herzegovina", display: "Saraybosna" },
                // Schweden & Norwegen
                { name: "Stockholm", country: "Sweden", display: "Stockholm" },
                { name: "Oslo", country: "Norway", display: "Oslo" },
                // Spanien & Portugal
                { name: "Madrid", country: "Spain", display: "Madrid" },
                { name: "Barcelona", country: "Spain", display: "Barcelona" },
                { name: "Lissabon", country: "Portugal", display: "Lizbon" },
                // Italien & Griechenland
                { name: "Rom", country: "Italy", display: "Rom" },
                { name: "Mailand", country: "Italy", display: "Milano" },
                { name: "Athen", country: "Greece", display: "Atina" },
                // Polen & Tschechien
                { name: "Warschau", country: "Poland", display: "Var≈üova" },
                { name: "Prag", country: "Czech Republic", display: "Prag" },
                // Russland
                { name: "Moskau", country: "Russia", display: "Moskova" },
                { name: "Sankt Petersburg", country: "Russia", display: "St. Petersburg" },
                // Kanada & USA
                { name: "Toronto", country: "Canada", display: "Toronto" },
                { name: "Vancouver", country: "Canada", display: "Vancouver" },
                { name: "New York", country: "United States", display: "New York" },
                { name: "Los Angeles", country: "United States", display: "Los Angeles" },
                // Australien
                { name: "Sydney", country: "Australia", display: "Sydney" },
                { name: "Melbourne", country: "Australia", display: "Melbourne" },
                // Brasilien
                { name: "S√£o Paulo", country: "Brazil", display: "S√£o Paulo" },
                { name: "Rio de Janeiro", country: "Brazil", display: "Rio de Janeiro" },
                // S√ºdafrika
                { name: "Johannesburg", country: "South Africa", display: "Johannesburg" },
                { name: "Kapstadt", country: "South Africa", display: "Kapstadt" },
                // Japan & China
                { name: "Tokio", country: "Japan", display: "Tokio" },
                { name: "Peking", country: "China", display: "Pekin" },
                { name: "Shanghai", country: "China", display: "≈ûanghay" },
                // Thailand & Vietnam
                { name: "Bangkok", country: "Thailand", display: "Bangkok" },
                { name: "Hanoi", country: "Vietnam", display: "Hanoi" },
                // Philippinen
                { name: "Manila", country: "Philippines", display: "Manila" },
                // Bangladesch
                { name: "Dhaka", country: "Bangladesh", display: "Dhaka" },
                // Afghanistan
                { name: "Kabul", country: "Afghanistan", display: "Kabil" },
                // Irak & Syrien
                { name: "Bagdad", country: "Iraq", display: "Baƒüdat" },
                { name: "Damaskus", country: "Syria", display: "≈ûam" },
                // Libanon & Pal√§stina
                { name: "Beirut", country: "Lebanon", display: "Beyrut" },
                { name: "Jerusalem", country: "Palestine", display: "Kud√ºs" },
                // Israel
                { name: "Tel Aviv", country: "Israel", display: "Tel Aviv" },
                // Iran
                { name: "Teheran", country: "Iran", display: "Tahran" },
                // Jordanien
                { name: "Amman", country: "Jordan", display: "Amman" },
                // Oman & Jemen
                { name: "Maskat", country: "Oman", display: "Maskat" },
                { name: "Sanaa", country: "Yemen", display: "Sana'a" },
                // VAE weitere
                { name: "Sharjah", country: "United Arab Emirates", display: "≈ûarjah" },
                // Argentinien
                { name: "Buenos Aires", country: "Argentina", display: "Buenos Aires" },
                // Mexiko
                { name: "Mexiko-Stadt", country: "Mexico", display: "Meksiko City" },
                // Kolumbien
                { name: "Bogot√°", country: "Colombia", display: "Bogot√°" },
                // Chile
                { name: "Santiago", country: "Chile", display: "Santiago" },
                // Aserbaidschan
                { name: "Baku", country: "Azerbaijan", display: "Baku" },
                { name: "Ganja", country: "Azerbaijan", display: "Ganja" },
                // Kasachstan
                { name: "Almaty", country: "Kazakhstan", display: "Almaty" },
                { name: "Nur-Sultan", country: "Kazakhstan", display: "Nur-Sultan" },
                // Usbekistan
                { name: "Taschkent", country: "Uzbekistan", display: "Ta≈ükent" },
                { name: "Samarkand", country: "Uzbekistan", display: "Semerkand" },
                { name: "Buchara", country: "Uzbekistan", display: "Bukhara" },
                // Tadschikistan
                { name: "Duschanbe", country: "Tajikistan", display: "Du≈üanbe" },
                // Turkmenistan
                { name: "A≈ügabat", country: "Turkmenistan", display: "A≈ügabat" },
                // Kirgistan
                { name: "Bischkek", country: "Kyrgyzstan", display: "Bi≈ükek" },
                // Georgien
                { name: "Tiflis", country: "Georgia", display: "Tiflis" },
                { name: "Batumi", country: "Georgia", display: "Batumi" },
                // Armenien
                { name: "Eriwan", country: "Armenia", display: "Yerevan" },
                // Litauen
                { name: "Vilnius", country: "Lithuania", display: "Vilnius" },
                // Lettland
                { name: "Riga", country: "Latvia", display: "Riga" },
                // Estland
                { name: "Tallinn", country: "Estonia", display: "Tallinn" },
                // Bulgarien
                { name: "Sofia", country: "Bulgaria", display: "Sofya" },
                // Rum√§nien
                { name: "Bukarest", country: "Romania", display: "B√ºkre≈ü" },
                // Moldau
                { name: "Chi≈üinƒÉu", country: "Moldova", display: "Chi≈üinƒÉu" },
                // Ungarn
                { name: "Budapest", country: "Hungary", display: "Budape≈üte" },
                // Serbien
                { name: "Belgrad", country: "Serbia", display: "Belgrat" },
                // Kroatien
                { name: "Zagreb", country: "Croatia", display: "Zagreb" },
                // Slowenien
                { name: "Ljubljana", country: "Slovenia", display: "Ljubljana" },
                // Mazedonien
                { name: "Skopje", country: "North Macedonia", display: "√úsk√ºp" },
                // Bulgarien
                { name: "Plovdiv", country: "Bulgaria", display: "Plovdiv" },
                // Malta
                { name: "Valletta", country: "Malta", display: "Valletta" },
                // Zypern
                { name: "Nikosia", country: "Cyprus", display: "Lefko≈üa" },
                // Luxemburg
                { name: "Luxemburg", country: "Luxembourg", display: "L√ºksemburg" },
                // Litauen
                { name: "Kaunas", country: "Lithuania", display: "Kaunas" },
                // Lettland weitere
                { name: "Daugavpils", country: "Latvia", display: "Daugavpils" },
                // Mongolei
                { name: "Ulaanbaatar", country: "Mongolia", display: "Ulaanbaatar" },
                // Nepal
                { name: "Kathmandu", country: "Nepal", display: "Katmandu" },
                // Sri Lanka
                { name: "Colombo", country: "Sri Lanka", display: "Colombo" },
                // Malediven
                { name: "Male", country: "Maldives", display: "Male" },
                // Myanmar
                { name: "Yangon", country: "Myanmar", display: "Yangon" },
                // Kambodscha
                { name: "Phnom Penh", country: "Cambodia", display: "Phnom Penh" },
                // Laos
                { name: "Vientiane", country: "Laos", display: "Vientiane" },
                // Osttimor
                { name: "Dili", country: "East Timor", display: "Dili" },
                // Papua-Neuguinea
                { name: "Port Moresby", country: "Papua New Guinea", display: "Port Moresby" },
                // Neuseeland
                { name: "Auckland", country: "New Zealand", display: "Auckland" },
                { name: "Wellington", country: "New Zealand", display: "Wellington" },
                // Fiji
                { name: "Suva", country: "Fiji", display: "Suva" },
                // Samoa
                { name: "Apia", country: "Samoa", display: "Apia" },
                // Kenia
                { name: "Nairobi", country: "Kenya", display: "Nairobi" },
                // Uganda
                { name: "Kampala", country: "Uganda", display: "Kampala" },
                // Tanzania
                { name: "Dar es Salaam", country: "Tanzania", display: "Dar es Selam" },
                // √Ñthiopien
                { name: "Addis Ababa", country: "Ethiopia", display: "Addis Ababa" },
                // Somalia
                { name: "Mogadishu", country: "Somalia", display: "Mogadi≈üu" },
                // Sudan
                { name: "Khartoum", country: "Sudan", display: "Hartum" },
                // Libyen
                { name: "Tripoli", country: "Libya", display: "Trablus" },
                // Algerien
                { name: "Algier", country: "Algeria", display: "Cezayir" },
                // Nigeria
                { name: "Lagos", country: "Nigeria", display: "Lagos" },
                { name: "Abuja", country: "Nigeria", display: "Abuja" },
                // Ghana
                { name: "Accra", country: "Ghana", display: "Akra" },
                // Senegal
                { name: "Dakar", country: "Senegal", display: "Dakar" },
                // Mali
                { name: "Bamako", country: "Mali", display: "Bamako" },
                // C√¥te d'Ivoire
                { name: "Abidjan", country: "Ivory Coast", display: "Abidjan" },
                // Kamerun
                { name: "Douala", country: "Cameroon", display: "Douala" },
                // Gabun
                { name: "Libreville", country: "Gabon", display: "Libreville" },
                // Kongo
                { name: "Brazzaville", country: "Congo", display: "Brazzaville" },
                // DR Kongo
                { name: "Kinshasa", country: "Democratic Republic of Congo", display: "Kin≈üasa" },
                // Angola
                { name: "Luanda", country: "Angola", display: "Luanda" },
                // Sambia
                { name: "Lusaka", country: "Zambia", display: "Lusaka" },
                // Zimbabwe
                { name: "Harare", country: "Zimbabwe", display: "Harare" },
                // Botswana
                { name: "Gaborone", country: "Botswana", display: "Gaborone" },
                // Namibia
                { name: "Windhoek", country: "Namibia", display: "Windhoek" },
                // Lesotho
                { name: "Maseru", country: "Lesotho", display: "Maseru" },
                // Eswatini
                { name: "Mbabane", country: "Eswatini", display: "Mbabane" },
                // Mauritius
                { name: "Port Louis", country: "Mauritius", display: "Port Louis" },
                // Seychellen
                { name: "Victoria", country: "Seychelles", display: "Victoria" },
                // Puerto Rico
                { name: "San Juan", country: "Puerto Rico", display: "San Juan" },
                // Dominikanische Republik
                { name: "Santo Domingo", country: "Dominican Republic", display: "Santo Domingo" },
                // Jamaika
                { name: "Kingston", country: "Jamaica", display: "Kingston" },
                // Kuba
                { name: "Havana", country: "Cuba", display: "Havana" },
                // Trinidad und Tobago
                { name: "Port of Spain", country: "Trinidad and Tobago", display: "Port of Spain" },
                // Belize
                { name: "Belize City", country: "Belize", display: "Belize City" },
                // Costa Rica
                { name: "San Jos√©", country: "Costa Rica", display: "San Jos√©" },
                // Panama
                { name: "Panama City", country: "Panama", display: "Panama City" },
                // El Salvador
                { name: "San Salvador", country: "El Salvador", display: "San Salvador" },
                // Honduras
                { name: "Tegucigalpa", country: "Honduras", display: "Tegucigalpa" },
                // Guatemala
                { name: "Guatemala City", country: "Guatemala", display: "Guatemala City" },
                // Nicaragua
                { name: "Managua", country: "Nicaragua", display: "Managua" },
                // Ekuador
                { name: "Quito", country: "Ecuador", display: "Quito" },
                // Peru
                { name: "Lima", country: "Peru", display: "Lima" },
                // Bolivien
                { name: "La Paz", country: "Bolivia", display: "La Paz" },
                // Paraguay
                { name: "Asunci√≥n", country: "Paraguay", display: "Asunci√≥n" },
                // Uruguay
                { name: "Montevideo", country: "Uruguay", display: "Montevideo" },
                // Venezuela
                { name: "Caracas", country: "Venezuela", display: "Caracas" },
                // Guyana
                { name: "Georgetown", country: "Guyana", display: "Georgetown" },
                // Surinam
                { name: "Paramaribo", country: "Suriname", display: "Paramaribo" }
            ];
            
            cities = citiesData;
        } catch (err) {
            console.error("Fehler beim Laden der St√§dte:", err);
        }
    }
    
    // Lade St√§dte beim Start
    loadCitiesFromAPI();

    function initializeCityGrid() {
        const cityGrid = document.getElementById("cityGrid");
        // Sortiere St√§dte alphabetisch
        const sortedCities = cities.sort((a, b) => a.display.localeCompare(b.display));
        
        cityGrid.innerHTML = sortedCities.map(city => 
            `<button class="city-btn" data-city="${city.name}" data-country="${city.country}" data-display="${city.display}">
                ${city.display}
            </button>`
        ).join("");

        document.querySelectorAll(".city-btn").forEach(btn => {
            btn.addEventListener("click", function() {
                const city = this.getAttribute("data-city");
                const country = this.getAttribute("data-country");
                selectCity(city, country);
                // Schlie√üe die Dropdown nach Auswahl
                document.getElementById("searchBox").value = "";
                document.querySelectorAll(".city-btn").forEach(b => b.style.display = "block");
                const noResults = document.querySelector(".no-results");
                if (noResults) noResults.remove();
            });
        });
    }

    function selectCity(city, country) {
        currentCity = city;
        currentCountry = country;
        currentLat = null;
        currentLon = null;
        useGPS = false;
        
        document.querySelectorAll(".city-btn").forEach(btn => btn.classList.remove("selected"));
        document.querySelector(`[data-city="${city}"]`)?.classList.add("selected");
        
        updateLocationDisplay();
        fetchPrayerTimes();
    }

    document.getElementById("searchBox").addEventListener("input", function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        let visibleCount = 0;
        
        document.querySelectorAll(".city-btn").forEach(btn => {
            const cityName = btn.getAttribute("data-city").toLowerCase();
            const displayName = btn.getAttribute("data-display").toLowerCase();
            const country = btn.getAttribute("data-country").toLowerCase();
            
            // Wenn Suchfeld leer ist, alle anzeigen
            if (searchTerm.length === 0) {
                btn.style.display = "block";
                visibleCount++;
            } else {
                // Suche in Stadt-Name, Anzeigename und Land
                const matches = cityName.includes(searchTerm) || 
                               displayName.includes(searchTerm) || 
                               country.includes(searchTerm);
                
                if (matches) {
                    btn.style.display = "block";
                    visibleCount++;
                } else {
                    btn.style.display = "none";
                }
            }
        });

        // Zeige "Keine Ergebnisse" wenn nichts gefunden
        let noResultsDiv = document.querySelector(".no-results");
        if (visibleCount === 0 && searchTerm.length > 0) {
            if (!noResultsDiv) {
                noResultsDiv = document.createElement("div");
                noResultsDiv.className = "no-results";
                noResultsDiv.textContent = "‚ùå Keine St√§dte gefunden";
                document.getElementById("cityGrid").appendChild(noResultsDiv);
            }
        } else if (noResultsDiv) {
            noResultsDiv.remove();
        }
    });

    document.getElementById("gpsBtn").addEventListener("click", function() {
        if (navigator.geolocation) {
            this.textContent = "‚è≥ Ort wird ermittelt...";
            this.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLat = position.coords.latitude;
                    currentLon = position.coords.longitude;
                    useGPS = true;
                    
                    document.getElementById("gpsBtn").classList.add("active");
                    document.getElementById("cityBtn").classList.remove("active");
                    document.getElementById("citySelector").classList.remove("active");
                    
                    this.textContent = "üìç GPS";
                    this.disabled = false;
                    
                    updateLocationDisplay();
                    fetchPrayerTimes();
                },
                (error) => {
                    showToast("GPS-Zugriff fehlgeschlagen");
                    this.textContent = "üìç GPS";
                    this.disabled = false;
                }
            );
        }
    });

    document.getElementById("cityBtn").addEventListener("click", function() {
        useGPS = false;
        document.getElementById("gpsBtn").classList.remove("active");
        document.getElementById("cityBtn").classList.add("active");
        document.getElementById("citySelector").classList.add("active");
        document.getElementById("settingsPanel").classList.remove("active");
    });

    document.getElementById("settingsBtn").addEventListener("click", function() {
        this.classList.toggle("active");
        document.getElementById("settingsPanel").classList.toggle("active");
        document.getElementById("citySelector").classList.remove("active");
    });

    document.getElementById("methodSelect").addEventListener("change", function(e) {
        prayerMethod = e.target.value;
        fetchPrayerTimes();
    });

    document.getElementById("notificationToggle").addEventListener("click", function() {
        notificationsEnabled = !notificationsEnabled;
        this.classList.toggle("active");
        if (notificationsEnabled && "Notification" in window) {
            Notification.requestPermission();
        }
        showToast(notificationsEnabled ? "Benachrichtigungen aktiviert" : "Benachrichtigungen deaktiviert");
    });

    document.getElementById("refreshBtn").addEventListener("click", () => {
        fetchPrayerTimes();
    });

    document.getElementById("copyTimesBtn").addEventListener("click", () => {
        if (prayerData) {
            const text = `NAMAZ VAKTƒ∞ - ${currentCity}\n${prayerData.gregorian}\n\nƒ∞msak: ${prayerData.imsak}\nG√ºne≈ü: ${prayerData.gunes}\n√ñƒüle: ${prayerData.ogle}\nƒ∞kindi: ${prayerData.ikindi}\nAk≈üam: ${prayerData.aksam}\nYatsƒ±: ${prayerData.yatsi}`;
            navigator.clipboard.writeText(text);
            showToast("Gebetszeiten kopiert!");
        }
    });

    document.getElementById("shareBtn").addEventListener("click", () => {
        if (prayerData && navigator.share) {
            navigator.share({
                title: "Namaz Vakti",
                text: `Gebetszeiten f√ºr ${currentCity}:\n${prayerData.gregorian}`,
                url: window.location.href
            }).catch(err => console.log("Fehler beim Teilen:", err));
        } else if (prayerData) {
            showToast("Teilen wird von diesem Browser nicht unterst√ºtzt");
        }
    });

    function updateLocationDisplay() {
        const locationDisplay = document.getElementById("locationDisplay");
        const countryDisplayMap = {
            "Germany": "Almanya", "Turkey": "T√ºrkiye", "Austria": "Avusturya",
            "Netherlands": "Hollanda", "France": "Fransa", "Belgium": "Bel√ßika",
            "Switzerland": "ƒ∞svi√ßre", "United Kingdom": "Birle≈üik Krallƒ±k", "UAE": "BAE", "Egypt": "Mƒ±sƒ±r", "Saudi Arabia": "Suudi Arabistan"
        };
        
        if (useGPS && currentLat && currentLon) {
            locationDisplay.textContent = `üìç GPS: ${currentLat.toFixed(4)}¬∞, ${currentLon.toFixed(4)}¬∞`;
        } else {
            const countryDisplay = countryDisplayMap[currentCountry] || currentCountry;
            locationDisplay.textContent = `üìç ${currentCity}, ${countryDisplay}`;
        }
    }

    function setStatus(status) {
        const indicator = document.getElementById("statusIndicator");
        indicator.className = `status-indicator ${status}`;
    }

    function showToast(message) {
        const toast = document.createElement("div");
        toast.className = "notification-toast";
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = "slideIn 0.3s ease reverse";
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

  async function fetchPrayerTimes(attempt = 1) {
    setStatus("loading");
    const maxAttempts = 3;
    try {
      let apiUrl;
      if (useGPS && currentLat && currentLon) {
        apiUrl = `https://api.aladhan.com/v1/timings?latitude=${currentLat}&longitude=${currentLon}&method=${prayerMethod}`;
      } else {
        const encodedCity = encodeURIComponent(currentCity);
        const encodedCountry = encodeURIComponent(currentCountry);
        apiUrl = `https://api.aladhan.com/v1/timingsByCity?city=${encodedCity}&country=${encodedCountry}&method=${prayerMethod}`;
      }

      // Timeout (10s) und optionales no-store, um Caching-Probleme zu vermeiden
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 10000);
      const response = await fetch(apiUrl, { signal: controller.signal, cache: 'no-store' });
      clearTimeout(timeout);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const data = await response.json();
      if (data.code !== 200) throw new Error("API Fehler");

      const timings = data.data.timings;
      const date = data.data.date;

      const dayNamesDE = { Monday: "Montag", Tuesday: "Dienstag", Wednesday: "Mittwoch", Thursday: "Donnerstag", Friday: "Freitag", Saturday: "Samstag", Sunday: "Sonntag" };
      const monthNamesDE = { January: "Januar", February: "Februar", March: "M√§rz", April: "April", May: "Mai", June: "Juni", July: "Juli", August: "August", September: "September", October: "Oktober", November: "November", December: "Dezember" };

      const gregDay = String(date.gregorian.day).padStart(2, "0");
      const gregMonth = monthNamesDE[date.gregorian.month.en] || date.gregorian.month.en;
      const gregYear = date.gregorian.year;
      const gregWeekday = date.gregorian.weekday.en;
      const hijriMonth = date.hijri.month.ar;
      const hijriYear = date.hijri.year;

      prayerData = {
        gregorian: `${gregDay}. ${gregMonth} ${gregYear}`,
        weekday: dayNamesDE[gregWeekday] || gregWeekday,
        hijri: `${date.hijri.day} ${hijriMonth} ${hijriYear}`,
        imsak: timings.Fajr || timings.Imsak,
        gunes: timings.Sunrise,
        ogle: timings.Dhuhr,
        ikindi: timings.Asr,
        aksam: timings.Maghrib,
        yatsi: timings.Isha
      };

      displayPrayerTimes(prayerData);
      setStatus("success");
      startCountdown();

      // Cache speichern f√ºr Offline-Fallback
      try { localStorage.setItem("prayerCache", JSON.stringify({ ts: Date.now(), city: currentCity, country: currentCountry, method: prayerMethod, data: prayerData })); } catch(_) {}
    } catch (err) {
      console.warn(`Fetch Versuch ${attempt} fehlgeschlagen:`, err.message);
      if (attempt < maxAttempts) {
        const backoff = attempt * 2000;
        showToast(`Netzwerkproblem ‚Äì neuer Versuch in ${(backoff/1000).toFixed(0)}s`);
        setTimeout(() => fetchPrayerTimes(attempt + 1), backoff);
      } else {
        setStatus("error");
        showError(`Namaz vakitleri y√ºklenirken hata olu≈ütu: ${err.message}`);

        // Cache-Fallback anzeigen, falls vorhanden
        try {
          const cached = JSON.parse(localStorage.getItem("prayerCache"));
          if (cached && cached.data) {
            prayerData = cached.data;
            displayPrayerTimes(prayerData);
            startCountdown();
            showToast(navigator.onLine ? "Cache genutzt (letzte Daten)" : "Offline ‚Äì Cache-Daten");
          }
        } catch(_) {}
      }
    }
  }

    function displayPrayerTimes(data) {
        document.getElementById("gregorianDate").textContent = `${data.weekday || ""} ${data.gregorian}`;
        document.getElementById("hijriDate").textContent = data.hijri;

        const prayers = [
            { name: "ƒ∞msak", time: data.imsak, key: "imsak", emoji: "üåô" },
            { name: "G√ºne≈ü", time: data.gunes, key: "gunes", emoji: "üåÖ" },
            { name: "√ñƒüle", time: data.ogle, key: "ogle", emoji: "‚òÄÔ∏è" },
            { name: "ƒ∞kindi", time: data.ikindi, key: "ikindi", emoji: "üå§Ô∏è" },
            { name: "Ak≈üam", time: data.aksam, key: "aksam", emoji: "üåÜ" },
            { name: "Yatsƒ±", time: data.yatsi, key: "yatsi", emoji: "‚≠ê" }
        ];

        const grid = document.getElementById("prayerTimesGrid");
        grid.innerHTML = prayers.map(prayer => 
            `<div class="prayer-card" data-prayer="${prayer.key}">
                <div style="position: absolute; top: 8px; right: 12px; font-size: 20px;">${prayer.emoji}</div>
                <div class="prayer-name">${prayer.name}</div>
                <div class="prayer-time">${prayer.time}</div>
            </div>`
        ).join("");

        updatePrayerStatus(prayers);
    }

    function updatePrayerStatus(prayers) {
        const now = new Date();
        const currentTimeStr = String(now.getHours()).padStart(2, "0") + ":" + String(now.getMinutes()).padStart(2, "0");
        
        let nextPrayer = null;
        let nextPrayerTime = null;

        for (let i = 0; i < prayers.length; i++) {
            const prayerTime = prayers[i].time;
            if (prayerTime > currentTimeStr) {
                nextPrayer = prayers[i];
                nextPrayerTime = prayerTime;
                break;
            }
        }

        document.querySelectorAll(".prayer-card").forEach(card => {
            card.classList.remove("active", "upcoming");
        });

        if (nextPrayer) {
            const nextCard = document.querySelector(`[data-prayer="${nextPrayer.key}"]`);
            if (nextCard) nextCard.classList.add("upcoming");
            
            document.getElementById("nextPrayerInfo").textContent = `Sonraki Namaz: ${nextPrayer.name}`;
            updateCountdownDisplay(nextPrayerTime);

            // Benachrichtigung
            if (notificationsEnabled && lastNotifiedPrayer !== nextPrayer.key) {
                sendNotification(nextPrayer.name, nextPrayerTime);
                lastNotifiedPrayer = nextPrayer.key;
            }
        } else {
            document.getElementById("nextPrayerInfo").textContent = "Bug√ºn√ºn Namazlarƒ± Bitti";
            document.getElementById("countdownTimer").textContent = "--:--:--";
        }
    }

    function sendNotification(prayerName, prayerTime) {
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification(`${prayerName} - ${prayerTime}`, {
                body: `Namaz Zeit: ${prayerName} um ${prayerTime}`,
                icon: "üïå"
            });
        }
    }

    function updateCountdownDisplay(targetTime) {
        const [targetHour, targetMinute] = targetTime.split(":").map(Number);
        const now = new Date();
        let target = new Date();
        target.setHours(targetHour, targetMinute, 0);

        if (target < now) {
            target.setDate(target.getDate() + 1);
        }

        const diff = target - now;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        document.getElementById("countdownTimer").textContent = 
            `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    }

    function startCountdown() {
        if (countdownInterval) clearInterval(countdownInterval);

        const updateClock = () => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, "0");
            const minutes = String(now.getMinutes()).padStart(2, "0");
            const seconds = String(now.getSeconds()).padStart(2, "0");
            document.getElementById("currentTime").textContent = `${hours}:${minutes}:${seconds}`;

            if (prayerData) {
                const prayers = [
                    { name: "ƒ∞msak", time: prayerData.imsak, key: "imsak", emoji: "üåô" },
                    { name: "G√ºne≈ü", time: prayerData.gunes, key: "gunes", emoji: "üåÖ" },
                    { name: "√ñƒüle", time: prayerData.ogle, key: "ogle", emoji: "‚òÄÔ∏è" },
                    { name: "ƒ∞kindi", time: prayerData.ikindi, key: "ikindi", emoji: "üå§Ô∏è" },
                    { name: "Ak≈üam", time: prayerData.aksam, key: "aksam", emoji: "üåÜ" },
                    { name: "Yatsƒ±", time: prayerData.yatsi, key: "yatsi", emoji: "‚≠ê" }
                ];
                updatePrayerStatus(prayers);
            }
        };

        updateClock();
        countdownInterval = setInterval(updateClock, 1000);
    }

    function showError(message) {
        const grid = document.getElementById("prayerTimesGrid");
        grid.innerHTML = `<div class="error">${message}</div>`;
    }

    // Initialize on page load
    window.addEventListener("load", () => {
        loadCitiesFromAPI();
        setTimeout(() => {
            initializeCityGrid();
            selectCity("Berlin", "Germany");
            document.getElementById("methodSelect").value = prayerMethod;
        }, 100);
    });

    // Auto-refresh every 10 minutes
    setInterval(() => {
        fetchPrayerTimes();
    }, 10 * 60 * 1000);

    // Keyboard shortcuts
    document.addEventListener("keydown", (e) => {
        if (e.key === "r" || e.key === "R") fetchPrayerTimes();
        if (e.key === "g" || e.key === "G") document.getElementById("gpsBtn").click();
        if (e.key === "s" || e.key === "S") document.getElementById("settingsBtn").click();
    });

  // Online/Offline Feedback und Auto-Refresh bei Online
  window.addEventListener("offline", () => showToast("Offline ‚Äì versuche Cache zu nutzen"));
  window.addEventListener("online", () => { showToast("Online ‚Äì aktualisiere Daten"); fetchPrayerTimes(); });
</script>
</body>
</html>