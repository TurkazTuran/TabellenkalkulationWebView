<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tabellenkalkulation</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      h1 {
        margin-bottom: 20px;
        color: #333;
      }

      .toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
      }

      button {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-add {
        background: #4caf50;
        color: white;
      }
      .btn-add:hover {
        background: #45a049;
      }
      .btn-delete {
        background: #f44336;
        color: white;
      }
      .btn-delete:hover {
        background: #da190b;
      }
      .btn-save {
        background: #2196f3;
        color: white;
      }
      .btn-save:hover {
        background: #0b7dda;
      }
      .btn-clear {
        background: #ff9800;
        color: white;
      }
      .btn-clear:hover {
        background: #e68900;
      }

      .table-wrapper {
        overflow-x: auto;
        margin-bottom: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
      }

      th {
        background: #2196f3;
        color: white;
        font-weight: 600;
        position: sticky;
        top: 0;
      }

      tbody tr:nth-child(even) {
        background: #f9f9f9;
      }

      tbody tr:hover {
        background: #e3f2fd;
      }

      input[type="text"],
      input[type="date"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      input:focus {
        outline: none;
        border-color: #2196f3;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
      }

      .amount-input {
        text-align: right;
      }

      .sum-row {
        background: #e3f2fd !important;
        font-weight: bold;
      }

      .sum-row td {
        border-top: 2px solid #2196f3;
      }

      .delete-btn {
        background: #f44336;
        color: white;
        border: none;
        padding: 8px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
      }

      .delete-btn:hover {
        background: #da190b;
      }

      .info-box {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        border-left: 4px solid #2196f3;
      }

      .info-box h3 {
        margin-bottom: 10px;
        color: #1976d2;
      }

      .total-display {
        font-size: 24px;
        color: #2196f3;
        font-weight: bold;
      }

      @media screen and (max-width: 768px) {
        body {
          padding: 12px;
        }

        .container {
          padding: 12px;
          box-shadow: none;
        }

        h1 {
          font-size: 22px;
        }

        .toolbar {
          gap: 8px;
          justify-content: center;
        }

        button {
          padding: 8px 12px;
          font-size: 13px;
        }

        .table-wrapper {
          overflow-x: visible;
        }

        table {
          min-width: 0;
          width: 100%;
        }

        table,
        tbody,
        tfoot,
        tr {
          display: block;
          width: 100%;
        }

        thead {
          display: none;
        }

        tbody tr {
          display: flex;
          flex-direction: column;
          gap: 12px;
          border: 1px solid #d7dce1;
          border-radius: 10px;
          padding: 16px 14px;
          margin-bottom: 18px;
          background: #ffffff;
          box-shadow: 0 4px 10px rgba(28, 80, 110, 0.08);
        }

        tbody tr:nth-child(even) {
          background: #ffffff;
        }

        td {
          border: none;
          padding: 0;
          display: flex;
          flex-direction: column;
          align-items: stretch;
          text-align: left;
        }

        td:before {
          content: attr(data-label);
          font-weight: 600;
          font-size: 13px;
          margin-bottom: 6px;
          color: #1a1d23;
        }

        input[type="text"],
        input[type="date"] {
          width: 100%;
          padding: 10px;
          font-size: 15px;
        }

        .amount-input {
          text-align: right;
        }

        .delete-btn {
          align-self: flex-start;
          padding: 8px 14px;
          font-size: 13px;
          width: auto;
        }

        .sum-row {
          display: grid;
          gap: 6px;
          padding: 14px;
          background: #e3f2fd;
          border-radius: 10px;
          margin-top: 18px;
        }

        .sum-row td {
          border: none;
          padding: 0;
          display: block;
          text-align: left;
        }
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <div class="container">
      <h1>üìä Monatliche Ausgaben</h1>

      <div class="info-box">
        <h3>
          Gesamtsumme: <span class="total-display" id="totalSum">0.00 ‚Ç¨</span>
        </h3>
      </div>

      <div class="toolbar">
        <button class="btn-add" onclick="addRow()">
          <i class="fa-solid fa-plus"></i> Zeile hinzuf√ºgen
        </button>
        <button class="btn-save" onclick="saveData(event)">
          <i class="fa-solid fa-floppy-disk"></i> Speichern
        </button>
        <button class="btn-save" onclick="loadData()">
          <i class="fa-solid fa-folder-open"></i> Laden
        </button>
        <button
          class="btn-save"
          onclick="document.getElementById('fileInput').click()"
        >
          <i class="fa-solid fa-file-import"></i> Excel importieren
        </button>
        <button class="btn-save" onclick="exportToExcel()">
          <i class="fa-solid fa-file-export"></i> Excel exportieren
        </button>
        <button class="btn-clear" onclick="clearAll()">
          <i class="fa-solid fa-trash-can"></i> Alles l√∂schen
        </button>
        <input
          type="file"
          id="fileInput"
          accept=".xlsx,.xls"
          style="display: none"
          onchange="importExcel(event)"
        />
      </div>      <div class="table-wrapper">
        <table id="dataTable">
          <thead>
            <tr>
              <th style="width: 150px">Datum der Buchung</th>
              <th style="width: 300px">Beschreibung der Geldinstitut</th>
              <th style="width: 150px">Betrag (‚Ç¨)</th>
              <th style="width: 100px">Aktion</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Zeilen werden hier eingef√ºgt -->
          </tbody>
          <tfoot>
            <tr class="sum-row">
              <td colspan="2" style="text-align: right">
                <strong>Gesamt:</strong>
              </td>
              <td id="sumCell"><strong>0.00 ‚Ç¨</strong></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <script>
              let rowCounter = 0;

              // Hilfsfunktionen f√ºr Zahlen
              function parseNormalizedNumber(value) {
                  if (typeof value === 'number') return value;
                  const s = String(value || '').trim().replace(/\s/g, '').replace(',', '.');
                  const num = parseFloat(s);
                  return isNaN(num) ? 0 : num;
              }

              function formatToTwoDecimals(value) {
                  const num = parseNormalizedNumber(value);
                  return Number.isFinite(num) ? num.toFixed(2) : '';
              }

              function formatAmountInput(inputEl) {
                  if (!inputEl) return;
                  if (inputEl.value === '') return;
                  inputEl.value = formatToTwoDecimals(inputEl.value);
              }

              // Daten beim Start laden
              window.addEventListener('load', () => {
                  loadData();
                  if (document.querySelectorAll('#tableBody tr').length === 0) {
                      addRow();
                  } else {
                      formatAllAmounts();
                      updateSum();
                  }
              });

              function buildAmountCell(value = '') {
                  const formatted = value === '' ? '' : formatToTwoDecimals(value);
                  return `
                      <input
                          type="text"
                          inputmode="decimal"
                          class="amount-input"
                          placeholder="0.00"
                          value="${formatted}"
                          oninput="updateSum()"
                          onblur="formatAmountInput(this); updateSum(); saveData()"
                      >
                  `;
              }

              function addRow() {
                  const tbody = document.getElementById('tableBody');
                  const row = document.createElement('tr');
                  row.id = 'row-' + rowCounter;

                  row.innerHTML = `
                      <td data-label="Datum"><input type="date" class="date-input" onchange="saveData()"></td>
                      <td data-label="Beschreibung"><input type="text" class="desc-input" placeholder="Beschreibung..." onchange="saveData()"></td>
                      <td data-label="Betrag (‚Ç¨)">${buildAmountCell('')}</td>
                      <td data-label="Aktion"><button class="delete-btn" onclick="deleteRow('row-${rowCounter}')">‚ùå L√∂schen</button></td>
                  `;

                  tbody.appendChild(row);
                  rowCounter++;
                  updateSum();
              }

              function deleteRow(rowId) {
                  const row = document.getElementById(rowId);
                  if (row) {
                      row.remove();
                      updateSum();
                      saveData();
                  }
              }

              function updateSum() {
                  const amounts = document.querySelectorAll('.amount-input');
                  let sum = 0;

                  amounts.forEach(input => {
                      const value = parseNormalizedNumber(input.value);
                      sum += value;
                  });

                  document.getElementById('sumCell').innerHTML = `<strong>${sum.toFixed(2)} ‚Ç¨</strong>`;
                  document.getElementById('totalSum').textContent = sum.toFixed(2) + ' ‚Ç¨';
              }

        function saveData(evt) {
                  const rows = document.querySelectorAll('#tableBody tr');
                  const data = [];

                  rows.forEach(row => {
                      const date = row.querySelector('.date-input').value;
                      const desc = row.querySelector('.desc-input').value;
                      const amountEl = row.querySelector('.amount-input');
                      const amount = amountEl.value ? formatToTwoDecimals(amountEl.value) : '';

                      if (date || desc || amount) {
                          data.push({ date, desc, amount });
                      }
                  });

                  localStorage.setItem('tableData', JSON.stringify(data));

          // Tempor√§re Best√§tigung nur wenn ein Speichern-Button geklickt wurde
          const rawTarget = evt?.target instanceof HTMLElement ? evt.target : null;
          const saveBtn = rawTarget?.closest('button');
          if (saveBtn && typeof saveBtn.textContent === 'string' && saveBtn.textContent.includes('Speichern')) {
            const originalText = saveBtn.textContent;
            saveBtn.textContent = '‚úÖ Gespeichert!';
            saveBtn.style.background = '#4CAF50';
            setTimeout(() => {
              saveBtn.textContent = originalText;
              saveBtn.style.background = '#2196F3';
            }, 1500);
                  }
              }

              function loadData() {
                  const savedData = localStorage.getItem('tableData');
                  if (savedData) {
                      const data = JSON.parse(savedData);
                      const tbody = document.getElementById('tableBody');
                      tbody.innerHTML = '';
                      rowCounter = 0;

                      data.forEach(item => {
                          const row = document.createElement('tr');
                          row.id = 'row-' + rowCounter;

                          row.innerHTML = `
                              <td data-label="Datum"><input type="date" class="date-input" value="${item.date || ''}" onchange="saveData()"></td>
                              <td data-label="Beschreibung"><input type="text" class="desc-input" value="${item.desc || ''}" onchange="saveData()"></td>
                              <td data-label="Betrag (‚Ç¨)">${buildAmountCell(item.amount || '')}</td>
                              <td data-label="Aktion"><button class="delete-btn" onclick="deleteRow('row-${rowCounter}')">‚ùå L√∂schen</button></td>
                          `;

                          tbody.appendChild(row);
                          rowCounter++;
                      });

                      formatAllAmounts();
                      updateSum();
                  }
              }

              function formatAllAmounts() {
                  document.querySelectorAll('.amount-input').forEach(input => {
                      if (input.value !== '') {
                          input.value = formatToTwoDecimals(input.value);
                      }
                  });
              }

              function clearAll() {
                  if (confirm('M√∂chten Sie wirklich alle Daten l√∂schen?')) {
                      document.getElementById('tableBody').innerHTML = '';
                      localStorage.removeItem('tableData');
                      rowCounter = 0;
                      updateSum();
                      addRow();
                  }
              }

              // Autosave bei √Ñnderungen
              document.addEventListener('input', (e) => {
                  if (e.target.classList.contains('date-input') ||
                      e.target.classList.contains('desc-input') ||
                      e.target.classList.contains('amount-input')) {
                      setTimeout(saveData, 500);
                  }
              });

              function importExcel(event) {
                  const file = event.target.files[0];
                  if (!file) return;

                  const reader = new FileReader();
                  reader.onload = function(e) {
                      try {
                          const data = new Uint8Array(e.target.result);
                          const workbook = XLSX.read(data, { type: 'array' });
                          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                          // Tabelle leeren
                          document.getElementById('tableBody').innerHTML = '';
                          rowCounter = 0;

                          // Daten importieren (erste Zeile √ºberspringen wenn Header)
                          const startRow = jsonData[0] && typeof jsonData[0][0] === 'string' ? 1 : 0;

                          for (let i = startRow; i < jsonData.length; i++) {
                              const rowData = jsonData[i];
                              if (!rowData || rowData.length === 0) continue;

                              const row = document.createElement('tr');
                              row.id = 'row-' + rowCounter;

                              let dateValue = '';
                              let descValue = rowData[1] ?? '';
                              let amountValue = '';

                              // Datum konvertieren
                              if (rowData[0]) {
                                  if (typeof rowData[0] === 'string' && rowData[0].includes('T')) {
                                      const date = new Date(rowData[0]);
                                      dateValue = date.toISOString().split('T')[0];
                                  } else if (typeof rowData[0] === 'number') {
                                      // Excel Datum Konvertierung
                                      const date = new Date((rowData[0] - 25569) * 86400 * 1000);
                                      dateValue = date.toISOString().split('T')[0];
                                  } else {
                                      dateValue = rowData[0];
                                  }
                              }

                              // Betrag
                              if (rowData[2] !== undefined && rowData[2] !== null && rowData[2] !== '') {
                                  amountValue = formatToTwoDecimals(rowData[2]);
                              }

                              row.innerHTML = `
                                  <td data-label="Datum"><input type="date" class="date-input" value="${dateValue}" onchange="saveData()"></td>
                                  <td data-label="Beschreibung"><input type="text" class="desc-input" value="${descValue}" onchange="saveData()"></td>
                                  <td data-label="Betrag (‚Ç¨)">${buildAmountCell(amountValue)}</td>
                                  <td data-label="Aktion"><button class="delete-btn" onclick="deleteRow('row-${rowCounter}')">‚ùå L√∂schen</button></td>
                              `;

                              document.getElementById('tableBody').appendChild(row);
                              rowCounter++;
                          }

                          updateSum();
                          saveData();
                          alert('Excel-Datei erfolgreich importiert!');
                      } catch (error) {
                          alert('Fehler beim Importieren: ' + error.message);
                      }
                  };
                  reader.readAsArrayBuffer(file);
                  event.target.value = ''; // Reset file input
              }

              function exportToExcel() {
          const rows = document.querySelectorAll('#tableBody tr');
          const data = [['Datum der Buchung', 'Beschreibung der Geldinstitut', 'Betrag']];

          // Daten sammeln
          rows.forEach(row => {
              const date = row.querySelector('.date-input').value;
              const desc = row.querySelector('.desc-input').value;
              const amountStr = row.querySelector('.amount-input').value;
              const amountNum = parseFloat(amountStr.toString().replace(',', '.')) || 0;

              if (date || desc || amountStr) {
                  data.push([date, desc, amountNum]);
              }
          });

          // Anzahl Datens√§tze (ohne Header)
          const dataRowsCount = data.length - 1; // ab Zeile 2 in Excel

          // Summe-Zeile hinzuf√ºgen (Formel oder 0, wenn keine Daten)
          const sumCell = dataRowsCount > 0
              ? { t: 'n', f: `SUM(C2:C${1 + dataRowsCount})`, z: '0.00' }
              : 0;
          data.push(['', 'Gesamt', sumCell]);

          // Sheet erstellen
          const ws = XLSX.utils.aoa_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Daten");

          // Zahlenformat f√ºr Spalte C (nur Datenzeilen) setzen
          // Excel-Zeilen: Daten sind 2..(1 + dataRowsCount)
          for (let excelRow = 2; excelRow <= 1 + dataRowsCount; excelRow++) {
              const ref = XLSX.utils.encode_cell({ r: excelRow - 1, c: 2 }); // 0-basiert
              const cell = ws[ref];
              if (cell && typeof cell.v === 'number') {
                  cell.z = '0.00';
              }
          }

          // Falls Summe-Zelle numerisch 0 (kein Datenbestand), auch formatieren
          const sumRowExcel = 1 + dataRowsCount + 1; // direkt unter den Daten
          const sumRef = XLSX.utils.encode_cell({ r: sumRowExcel - 1, c: 2 });
          if (ws[sumRef] && typeof ws[sumRef].v === 'number') {
              ws[sumRef].z = '0.00';
          }

          XLSX.writeFile(wb, "ausgaben_export.xlsx");
      }
    </script>
  </body>
</html>
